{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/dockerizing-android-builds","result":{"data":{"markdownRemark":{"html":"<p>Docker is a great container platform that helps building a true independence between applications, infrastructure and developers. It provides an isolation which supports building modern continuous integration environments with ease and at low cost.</p>\n<h1>Building Android applications</h1>\n<p>The easiest way to build an Android app is to use Android Studio, but how one can build the application without the IDE or even without a graphical interface (using only the command line)?</p>\n<h2>Android command line tools</h2>\n<p>Google provides a separate package of command line tools needed for building an application. The same tools are included with Android Studio, so you may be already familiar with some of them.\nThe package is available at the <a href=\"https://developer.android.com/studio/.html#downloads\">Android Studio downloads page</a> under the <em>Get just the command line tools</em> section. Since Docker images are Linux-based, we will use the Linux package, e.g. <a href=\"https://dl.google.com/android/repository/sdk-tools-linux-3859397.zip\">sdk-tools-linux-3859397.zip</a>.</p>\n<h2>sdkmanager</h2>\n<p>The <code>sdkmanager</code> tool can be used to manage (install, delete, update) all the SDK packages required to build the application.</p>\n<p>If you are not sure what packages you should install, but you already have an Android project and you are able to build it using Android Studio, you can deduce it using your local <code>sdkmanager</code>.</p>\n<p>You can locate it using the Android SDK section in Android Studio preferences. Open the SDK location and navigate to <code>tools/bin/</code> subdirectory.</p>\n<p><img src=\"/images/dockerizing-android-builds/as_sdk.png\" alt=\"Docker\">{: .center-image}</p>\n<p>Now, run <code>sdkmanager --list</code> command to see the list of installed and available (to install) packages. Some of them are required to build your project.</p>\n<p><em>(Note: you may prefer to also add <code>--verbose</code> to the <code>sdkmanager --list</code> commands which prevents shrinking the long package names)</em></p>\n<p>You should also visit your <code>build.gradle</code> files to find out the SDK dependencies, e.g. compile SDK version, build tools version, libraries etc.</p>\n<h2>Accepting licenses</h2>\n<p>Downloading some of the SDK packages may require to accept a separate license(s) first. While Android Studio shows a dialog with accept buttons, the command line <code>sdkmanager</code> displays a prompt like this:</p>\n<pre><code>---------------------------------------\nAccept? (y/N):\n</code></pre>\n<p>Unfortunately, the tool doesn't provide any parameter to automatically answer \"yes\", so it might be inconvenient when you try to automate this process. Thankfully, there are some ways to overcome this problem.</p>\n<h3>Solution 1: Copy accepted license agreements to the build machine</h3>\n<p>Every time you accept a license (using either Android Studio or command line), a license string is appended to a specific file located in <code>licenses/</code> subdirectory of Android SDK. Once accepted, you may install more packages covered by the same license without additional prompts. Moreover, Gradle build can automatically download missing SDK packages as long as the corresponding license agreements have already been accepted.</p>\n<p>This gives us an opportunity to get the accepted license files from the developer's computer and copy them to another machine, enabling the builds. This approach was also described in the <a href=\"https://developer.android.com/studio/intro/update.html#download-with-gradle\">Android user guide</a>.</p>\n<p>Of course copying files over and over again may be burdensome so instead you can just echo the license strings to the corresponding files automatically somewhere in the build process, e.g.</p>\n<pre><code># ANDROID_HOME is the Android SDK location\n\nmkdir \"$ANDROID_HOME/licenses\"\necho \"d56f5187479451eabf01fb78af6dfcb131a6481e\" > \"$ANDROID_HOME/licenses/android-sdk-license\"\necho \"8933bad161af4178b1185d1a37fbf41ea5269c55\" >> \"$ANDROID_HOME/licenses/android-sdk-license\"\necho \"84831b9409646a918e30573bab4c9c91346d8abd\" > \"$ANDROID_HOME/licenses/android-sdk-preview-license\"\n# More licenses if needed\n</code></pre>\n<p>But there is a catch with this approach: the license strings may change from time to time with Android SDK updates. When it happens, you must update them on the build machine again.</p>\n<h3>Solution 2: Accept all the licenses at once</h3>\n<p>The second way to accept the licenses automatically is to use the <code>yes</code> program and combine its output with the <code>sdkmanager --licenses</code> command. The latter one displays a series of prompts to accept all available and unaccepted yet licenses and the first one prints \"y\" continuously.</p>\n<pre><code>yes | sdkmanager --licenses\n</code></pre>\n<p>The main advantage of this approach is that it doesn't require you to maintain a list of license strings for echoing. Nevertheless you must run it again if the license strings get changed with an SDK update. The only drawback is that you don't know <em>a priori</em> what you are going to accept and it may be a bit more troublesome to compare your local licenses with the ones on the build machine without a direct access to it.</p>\n<p><img src=\"/images/dockerizing-android-builds/container-1574239_1920.jpg\" alt=\"Docker\">{: .center-image}</p>\n<h1>Wrapping it in a Docker container</h1>\n<p>In order to build an Android application inside a Docker container, you need an image that includes Java Development Kit (JDK) and Android SDK. While the process of getting the latter one was described above, you are yet to decide how to get the JDK.</p>\n<h2>Setting up a Dockerfile</h2>\n<p>The easiest way is to use the <code>openjdk</code> (<a href=\"https://hub.docker.com/_/openjdk/\">link</a>) as the basis for your image as it already has the JDK installed (as well as other useful tools). So the first line of your <code>Dockerfile</code> could be:</p>\n<pre><code>FROM openjdk:8\n</code></pre>\n<p>On the other hand, you can just get any image with <code>apt-get</code> e.g. <code>debian</code> (<a href=\"https://hub.docker.com/_/debian/\">link</a>) and install the JDK by yourself. You will also need some tools to download and unzip the Android SDK (in this example I use <code>wget</code> and <code>unzip</code>) so you can install all these packages at once.</p>\n<p><em>(Remember to follow the [Dockerfile best practices](<a href=\"https://docs.docker.com/engine/userguide/eng-image/dockerfile\">https://docs.docker.com/engine/userguide/eng-image/dockerfile</a></em>best-practices/))_</p>\n<pre><code>FROM debian\nRUN apt-get update &#x26;&#x26; \\\n    apt-get install -y openjdk-8-jdk wget unzip &#x26;&#x26; \\\n    rm -rf /var/lib/apt/lists/*\n</code></pre>\n<p>Now you can proceed to fetching the Android SDK. You should also set the <code>ANDROID_HOME</code> variable so that the application builds would know the SDK location. Using <code>wget</code> and <code>unzip</code> it may look like this:</p>\n<pre><code>ENV ANDROID_HOME /opt/android-sdk-linux\n\nRUN mkdir -p ${ANDROID_HOME} &#x26;&#x26; \\\n    cd ${ANDROID_HOME} &#x26;&#x26; \\\n    wget -q https://dl.google.com/android/repository/sdk-tools-linux-3859397.zip -O android_tools.zip &#x26;&#x26; \\\n    unzip android_tools.zip &#x26;&#x26; \\\n    rm android_tools.zip\n</code></pre>\n<p>It's also useful to add some SDK tools to the <code>PATH</code>:</p>\n<pre><code>ENV PATH ${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/tools/bin:${ANDROID_HOME}/platform-tools\n</code></pre>\n<p>The last step is to accept the Android SDK licenses using one of the mentioned ways, e.g.:</p>\n<pre><code>RUN yes | sdkmanager --licenses\n</code></pre>\n<h2>Building the image</h2>\n<p>Having the <code>Dockerfile</code> part completed it's time to build the image with <code>docker build</code> command. Please read some <a href=\"https://docs.docker.com/engine/reference/builder/#usage\">docs</a> first as it's easy to miss some important details like a possibility to accidentally tarball and transfer your whole disk to the Docker daemon ;)</p>\n<blockquote>\n<p>Warning: Do not use your root directory, /, as the PATH as it causes the build to transfer the entire contents of your hard drive to the Docker daemon.</p>\n</blockquote>\n<p>Let's say we build the image like this:</p>\n<pre><code>docker build -t my-sdk-image .\n</code></pre>\n<h2>Running the build</h2>\n<p>Now we can run a new container based on the built image. The container will need an access to your Android project sources and the simplest way is to mount the sources directory using the <code>-v</code> flag.</p>\n<p>Please also keep in mind that you probably have the <code>local.properties</code> file in your project directory which specifies the SDK location (overriding the <code>ANDROID_HOME</code> environment variable). I usually add this file to the <code>.gitignore</code> so in the continuous integration environment this file does not exist as it is not included in the repository. When you are testing the Dockerized builds locally, you can just remove or temporarily rename that file.</p>\n<p>Here is an exemplary command to run the build in a container:</p>\n<pre><code>docker run -v $(pwd):/home/app \\ # mount current directory\n           --rm \\                # remove the container when it exists\n           my-sdk-image \\        # image name\n           /bin/bash -c \"cd /home/app &#x26;&#x26; ./gradlew clean assembleDebug\"\n</code></pre>\n<p>If you use some environment variables during the build (e.g. to specify a build version), you can pass them from the host machine to the container using <code>-e</code> flags.</p>\n<p>When the build is finished, the build outputs are already available on your host machine thanks to the <code>-v</code> mounting.</p>\n<h1>Considerations</h1>\n<p>While the image is sufficient to build a regular application, you might want to further customize it for several reasons.</p>\n<h2>Pre-fetching SDK packages</h2>\n<p>First of all, I haven't specified any SDK packages to be downloaded using the <code>sdkmanager</code> in the <code>Dockerfile</code>. This means your Gradle build will need to download the missing packages every time you run it in the container, possibly causing severe network usage and additional time consumption. Thus you should consider preparing a <code>Dockerfile</code> which builds an image with pre-downloaded packages, but you should be careful with it as the resulting image's size will be significantly larger.</p>\n<p>For example, adding the following lines to the <code>Dockerfile</code> will make the image about 1 GB larger.</p>\n<pre><code>RUN sdkmanager 'platform-tools'\nRUN sdkmanager 'platforms;android-26'\nRUN sdkmanager 'build-tools;26.0.2'\nRUN sdkmanager 'extras;m2repository;com;android;support;constraint;constraint-layout-solver;1.0.2'\nRUN sdkmanager 'extras;m2repository;com;android;support;constraint;constraint-layout;1.0.2'\nRUN sdkmanager 'extras;google;m2repository'\nRUN sdkmanager 'extras;android;m2repository'\nRUN sdkmanager 'extras;google;google_play_services'\n</code></pre>\n<h2>NDK</h2>\n<p>As I don't use the <a href=\"https://developer.android.com/ndk/.html\">NDK</a> in my applications at the moment, I can't be 100% sure about all the requirements (please let me know if you have some more experience), but during a simple test with an empty NDK-enabled project I have already found some gotchas:</p>\n<ul>\n<li>NDK bundle must be installed manually with <code>sdkmanager ndk-bundle</code> (Gradle didn't install it automatically for me).</li>\n<li>When you are testing the Dockerized build locally, leaving the <code>app/.externalNativeBuild</code> directory from previous builds will make the build command fail due to wrong NDK location path (e.g. in the generated <code>ninja</code> and <code>CMakeCache</code> files).</li>\n</ul>\n<h1>Docker Hub</h1>\n<p>It's even easier to build Android applications by getting the images directly from <a href=\"https://hub.docker.com/\">Docker Hub</a>.</p>\n<p>I've just published <a href=\"https://hub.docker.com/u/azabost/\">my images (link)</a> there so if you don't need any customizations, you can run a container without your own <code>Dockerfile</code> like this:</p>\n<pre><code>docker run azabost/android-sdk\n</code></pre>\n<p>You can also use my images as a base for your image by specifying one of them in your <code>Dockerfile</code>:</p>\n<pre><code>FROM azabost/android-sdk\n</code></pre>","excerpt":"Docker is a great container platform that helps building a true independence between applications, infrastructure and developers. It…","frontmatter":{"slug":null,"title":"Dockerizing Android builds","description":null,"author":"azabost","tags":["android","build","docker"],"date":"2017-10-30T23:00:00.000Z","image":"/images/dockerizing-android-builds/container-1574239_1920.jpg"},"timeToRead":8,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2017-10-31-dockerizing-android-builds.md"},"allMarkdownRemark":{"nodes":[{"frontmatter":{"author_id":"adam","avatar":"/images/members/adam_bar.jpg","bio":"The Web Guy @ Bright Inventions","name":"Adam Bar","web":"https://whatwebcando.today"}},{"frontmatter":{"author_id":"agnieszka_h","avatar":"/images/members/agnieszka_h.jpg","bio":"Sales Manager @ Bright Inventions","name":"Agnieszka Hayashida","web":null}},{"frontmatter":{"author_id":"agnieszka","avatar":"/images/members/agnieszka_olszewska.jpg","bio":"Fullstack developer","name":"Agnieszka Olszewska","web":null}},{"frontmatter":{"author_id":"olo","avatar":"/images/members/aleksander_wielgorski.jpeg","bio":"Software Engineer @ Bright Inventions","name":"Aleksander Wielgórski","web":null}},{"frontmatter":{"author_id":"alisa","avatar":"/images/members/alisa_kashytska.jpg","bio":"Product designer","name":"Alisa Kashytska","web":null}},{"frontmatter":{"author_id":"azabost","avatar":"/images/members/andrzej_zabost.jpg","bio":"Senior Android developer","name":"Andrzej Zabost","web":"https://azabost.com"}},{"frontmatter":{"author_id":"arturs","avatar":"/images/members/artur.jpg","bio":"iOS developer","name":"Artur Suliński","web":null}},{"frontmatter":{"author_id":"bartek k","avatar":"/images/members/bartek_krzyzanski.jpg","bio":"Backend developer","name":"Bartek Krzyżański","web":null}},{"frontmatter":{"author_id":"bartekr","avatar":"/images/members/bartek.jpg","bio":"iOS developer","name":"Bartek Rozwarski","web":null}},{"frontmatter":{"author_id":"bartosz","avatar":"/images/members/bartosz_szafran.jpg","bio":"Senior Frontend Developer","name":"Bartosz Szafran","web":null}},{"frontmatter":{"author_id":"daniel","avatar":"/images/members/daniel_makurat.jpg","bio":"Co-founder & Senior Backend developer","name":"Daniel Makurat","web":null}},{"frontmatter":{"author_id":"eliasz","avatar":"/images/members/eliasz.png","bio":"Software Engineer @ Bright Inventions","name":"Eliasz Sawicki","web":"http://eluss.github.io/"}},{"frontmatter":{"author_id":"fjablonski","avatar":"/images/members/filip_jablonski.jpg","bio":"Senior iOS developer","name":"Filip Jabłoński","web":null}},{"frontmatter":{"author_id":"grzesiek","avatar":"/images/members/grzegorz_ciesla.jpg","bio":"Software Developer","name":"Grzegorz Cieśla","web":null}},{"frontmatter":{"author_id":"ivan","avatar":"/images/members/ivan.jpg","bio":"Fullstack developer","name":"Ivan Menshykov","web":null}},{"frontmatter":{"author_id":"janek","avatar":"/images/members/janhanc.jpg","bio":"Frontend developer","name":"Jan Hanc","web":null}},{"frontmatter":{"author_id":"kwysocki","avatar":"/images/members/kamil.png","bio":"Software Engineer @ Bright Inventions","name":"Kamil Wysocki","web":"https://wysockikamil.com"}},{"frontmatter":{"author_id":"karoln","avatar":"/images/members/karol_nadratowski.jpg","bio":null,"name":"Karol Nadratowski","web":null}},{"frontmatter":{"author_id":"karol r","avatar":"/images/members/karol_rinc.jpg","bio":"Backend developer","name":"Karol Rinc","web":null}},{"frontmatter":{"author_id":"kasia","avatar":"/images/members/kasia_lukasiewicz.jpg","bio":"Senior Project Manager","name":"Kasia Łukasiewicz","web":null}},{"frontmatter":{"author_id":"kasia g","avatar":"/images/members/katarzyna_galka.jpg","bio":"Project manager","name":"Katarzyna Gałka","web":null}},{"frontmatter":{"author_id":"krzysiek h","avatar":"/images/members/krzysztof_hinc.jpg","bio":"Web developer","name":"Krzysiek Hinc","web":null}},{"frontmatter":{"author_id":"krzysiek","avatar":"/images/members/krzysztof_kaczmarek.jpg","bio":"Senior iOS Developer","name":"Krzysztof Kaczmarek","web":null}},{"frontmatter":{"author_id":"maciej","avatar":"/images/members/maciej_seleman.jpg","bio":"QA Specialist","name":"Maciej Seleman","web":null}},{"frontmatter":{"author_id":"magda","avatar":"/images/members/magda_sadowska.jpg","bio":"Office & HR Assistant","name":"Magda Sadowska","web":null}},{"frontmatter":{"author_id":"maja","avatar":"/images/members/maja_puta.jpg","bio":"Junior QA Specialist","name":"Maja Puta","web":null}},{"frontmatter":{"author_id":"marcink","avatar":"/images/members/marcin_kwiatkowski.jpg","bio":null,"name":"Marcin Kwiatkowski","web":null}},{"frontmatter":{"author_id":"mateusz","avatar":"/images/members/mateusz_klimczak.jpg","bio":"Technical leader & Project manager","name":"Mateusz Klimczak","web":null}},{"frontmatter":{"author_id":"mateuszklimek","avatar":"/images/members/mateuszklimek.png","bio":"Software Engineer @ Bright Inventions","name":"Mateusz Klimek","web":null}},{"frontmatter":{"author_id":"michal k","avatar":"/images/members/michal_koszalka.jpg","bio":"Senior Backend developer","name":"Michał Koszałka","web":null}},{"frontmatter":{"author_id":"michał","avatar":"/images/members/michal_wrobel.jpg","bio":"Senior Backend Developer at Bright Inventions","name":"Michał Wróbel","web":null}},{"frontmatter":{"author_id":"michal","avatar":"/images/members/michał_łukasiewicz.jpg","bio":"Co-founder & Senior iOS developer","name":"Michał Łukasiewicz","web":null}},{"frontmatter":{"author_id":"monika","avatar":"/images/members/monika.jpg","bio":"Software Developer @ Bright Inventions","name":"Monika Niegrzybowska","web":null}},{"frontmatter":{"author_id":"nikodem","avatar":"/images/members/nikodem_kalinowski.jpg","bio":"Web developer","name":"Nikodem Kalinowski","web":null}},{"frontmatter":{"author_id":"patryk","avatar":"/images/members/patryk_huzarski.jpg","bio":"Software Developer @ Bright Inventions","name":"Patryk Huzarski","web":null}},{"frontmatter":{"author_id":"patryk sz","avatar":"/images/members/patryk_szlagowski.jpg","bio":"Senior Backend developer","name":"Patryk Szlagowski","web":null}},{"frontmatter":{"author_id":"paweł","avatar":"/images/members/paweł_gutkowski.jpg","bio":"Fullstack Developer at Bright Inventions ","name":"Paweł Gutkowski","web":null}},{"frontmatter":{"author_id":"pawel","avatar":"/images/members/paweł_papkiewicz.jpg","bio":"Fullstack developer","name":"Paweł Papkiewicz","web":null}},{"frontmatter":{"author_id":"piotr","avatar":"/images/members/piotr_mionskowski.jpg","bio":"TDD fan eager to learn new things","name":"Piotr Mionskowski","web":"https://miensol.pl"}},{"frontmatter":{"author_id":"piotr_l","avatar":"/images/members/piotrl.png","bio":"Android Developer @ Bright Inventions","name":"Piotr Łupiński","web":"http://exp.flamaster2.com"}},{"frontmatter":{"author_id":"radek","avatar":"/images/members/radek_pieczątkiewicz.jpg","bio":"Android developer","name":"Radek Pieczątkiewicz","web":null}},{"frontmatter":{"author_id":"radeks","avatar":"/images/members/radoslaw.jpg","bio":"Software Engineer @ Bright Inventions","name":"Radosław Słowiński","web":null}},{"frontmatter":{"author_id":"rafal h","avatar":"/images/members/rafal_hoffman.jpg","bio":"Fullstack developer","name":"Rafał Hofman","web":null}},{"frontmatter":{"author_id":"sebastian","avatar":"/images/members/sebastian_sobczak.jpg","bio":"Junior Account Manager at Bright Inventions ","name":"Sebastian Sobczak","web":null}},{"frontmatter":{"author_id":"szymek","avatar":"/images/members/szymon_miloch.jpg","bio":"Android & Web developer","name":"Szymon Miloch","web":null}},{"frontmatter":{"author_id":"tomek","avatar":"/images/members/tomek.jpeg","bio":null,"name":"Tomasz Gęsior","web":null}},{"frontmatter":{"author_id":"ula","avatar":"/images/members/ula_stankiewicz.jpg","bio":"HR & Marketing Manager","name":"Ula Stankiewicz","web":null}},{"frontmatter":{"author_id":"wojciech","avatar":"/images/members/wojciech_baczyński.jpg","bio":"Fullstack developer","name":"Wojciech Baczyński","web":null}},{"frontmatter":{"author_id":"lukasz","avatar":"/images/members/lukasz_reszetow.jpg","bio":"Android developer","name":"Łukasz Reszetow","web":null}}]},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2017-10-31-dockerizing-android-builds.md"}}}