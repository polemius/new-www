{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/testing-android-viewmodels","result":{"data":{"markdownRemark":{"html":"<p>In my <a href=\"https://brightinventions.pl/blog/injectable-android-viewmodels/\">previous post</a> I described how to implement injectable Android view models using Dagger and <a href=\"https://developer.android.com/topic/libraries/architecture/viewmodel.html\">ViewModel</a> library from <a href=\"https://developer.android.com/topic/libraries/architecture/.html\">Android Architecture Components</a>. In this post I will show a simple way to unit test the view model created then. You can find the full code in the same repository as previously <a href=\"https://github.com/azabost/simple-mvvm-example/tree/7b051fd7a16853e3d9655767a887d9a830133d2d\">on GitHub</a>.</p>\n<h1>The structure</h1>\n<p><img src=\"/images/testing-android-viewmodels/structure.svg\" alt=\"Structure\">{: .center-image}</p>\n<p>The <code>MainViewModel</code> view model exposes three <a href=\"https://github.com/ReactiveX/RxJava\">RxJava</a> <code>Observable</code>s which Activity (<code>MainActivity</code>) subscribes to in order to receive notifications, e.g. to display an error message. There is also the <code>getRepo</code> function that triggers fetching some data from the GitHub API and the <code>data</code> variable that stores the fetched data.</p>\n<p>The mentioned members are divided into three interfaces implemented by the view model but it's mainly for the clarity of the example (you can easily tell which members are used by the Activity and the Fragments).</p>\n<p>The only view model's dependency (provided by Dagger) is <code>GitHubClient</code> which has a method for fetching some data.</p>\n<p>It's also worth noting that the Activity and the Fragments use the same instance of <code>MainViewModel</code>. That's why it can both fetch the data when <code>LoadingFragment</code> requests it, tell <code>MainActivity</code> to show an error if anything goes wrong and work as a data store for <code>DataFragment</code>. In order to achieve this type of sharing the view model instance between the Activity and the Fragments, they must request the view model by passing the Activity reference while getting it:</p>\n<p><code>ViewModelProviders.of(activity, vmFactory).get(...)</code></p>\n<p><img src=\"/images/testing-android-viewmodels/stethoscope.jpg\" alt=\"Stethoscope\">{: .center-image}</p>\n<h1>Testing</h1>\n<h2>Prepare dependencies</h2>\n<p>Normally <code>MainViewModel</code> uses a <code>GitHubClient</code> implementation that calls the GitHub API using <a href=\"https://github.com/square/retrofit\">Retrofit</a> HTTP client. In tests you would probably prefer to either mock the server (e.g. with <a href=\"https://github.com/square/okhttp/tree/master/mockwebserver\">MockWebServer</a>) or just the <code>GitHubClient</code> implementation so that it won't make the calls at all. In this example I'm going to use the latter approach (but testing the calls to a mocked server is also a good idea and you can do it separately).</p>\n<h3>Mock API client</h3>\n<p>The mocked implementation of the <code>GitHubClient</code> is very simple. Its constructor accepts a response it should return, an optional error it should throw instead of the response and a scheduler so that we can control the exact moment the data/error is returned. The error and the response are mutable properties so we can adjust them just before calling <code>getRepo</code> method.</p>\n<pre><code class=\"language-kotlin\">import com.azabost.simplemvvm.net.response.RepoResponse\nimport io.reactivex.Observable\nimport io.reactivex.Scheduler\n\nclass MockGitHubClient(\n        val scheduler: Scheduler,\n        var repoResponse: RepoResponse = RepoResponse(1),\n        var error: Throwable? = null\n) : GitHubClient {\n\n    override fun getRepo(owner: String, repo: String): Observable&#x3C;RepoResponse> {\n        val response = error?.let { return Observable.error(it) } ?: Observable.just(repoResponse)\n        return response.subscribeOn(scheduler).observeOn(scheduler)\n    }\n}\n</code></pre>\n<p><em>Note: it can also be implemented using Mockito - you can find the updated version on GitHub.</em></p>\n<h3>Setting things up</h3>\n<p>I put all the <code>MainViewModel</code> tests in the <code>MainViewModelTests</code> class. It has a few properties:</p>\n<ul>\n<li><code>MainViewModel</code></li>\n<li><code>TestObserver</code>s for every <code>Observable</code> exposed by <code>MainViewModel</code></li>\n<li><code>MockGitHubClient</code></li>\n<li><code>TestScheduler</code> that is passed to <code>MockGitHubClient</code></li>\n</ul>\n<p>They are initialized in the <code>setup</code> method.</p>\n<p><code>TestObserver</code>s record events passed by <code>Observable</code>s and they allow to make assertions about them e.g. if a value has been emitted and what it was exactly.</p>\n<p><code>TestScheduler</code> controls the time when <code>MockGitHubClient</code> emits responses so that we can defer it and test what happens before the subscription completes (e.g. the progress animation should be still visible).</p>\n<pre><code class=\"language-kotlin\">class MainViewModelTests {\n    lateinit var vm: MainViewModel\n    lateinit var gitHubClient: MockGitHubClient\n    lateinit var testScheduler: TestScheduler\n    lateinit var progressObserver: TestObserver&#x3C;Boolean>\n    lateinit var errorObserver: TestObserver&#x3C;Int>\n    lateinit var showDataObserver: TestObserver&#x3C;Unit>\n\n    @Before\n    fun setup() {\n        testScheduler = TestScheduler()\n        gitHubClient = MockGitHubClient(testScheduler)\n        vm = MainViewModel(gitHubClient)\n        setupObservers(vm)\n    }\n\n    fun setupObservers(vm: MainViewModel) {\n        progressObserver = TestObserver.create()\n        vm.progress.subscribe(progressObserver)\n        errorObserver = TestObserver.create()\n        vm.errors.subscribe(errorObserver)\n        showDataObserver = TestObserver.create()\n        vm.showData.subscribe(showDataObserver)\n    }\n</code></pre>\n<h2>Writing some tests</h2>\n<p>Below you can find three simple examples.</p>\n<h3>Example 1</h3>\n<p>Test if positive response from the API triggers <code>showData</code> <code>Observable</code> and stores the data for later usage in the <code>data</code> variable.</p>\n<pre><code class=\"language-kotlin\">@Test\nfun getRepoShouldShowData() {\n    val data = RepoResponse(12345)\n    gitHubClient.repoResponse = data\n\n    vm.getRepo(\"any\", \"thing\")\n    testScheduler.triggerActions()\n\n    showDataObserver.assertValueCount(1)\n    vm.data.shouldEqual(data)\n}\n</code></pre>\n<p><em>Note: the <code>shouldEqual</code> method comes from <a href=\"https://github.com/miensol/shouldko\">ShouldKO</a> which I really recommend but you can use any assertions you like.</em></p>\n<h3>Example 2</h3>\n<p>Test if HTTP exception triggers <code>error</code> <code>Observable</code> with the HTTP-specific error message.</p>\n<pre><code class=\"language-kotlin\">@Test\nfun getRepoErrorShouldShowHttpError() {\n    gitHubClient.error = HttpErrors.getHttpException(404)\n\n    vm.getRepo(\"any\", \"thing\")\n    errorObserver.assertValue(HttpErrors.DEFAULT_HTTP_ERROR_MESSAGE)\n}\n</code></pre>\n<h3>Example 3</h3>\n<p>Test if calling <code>getRepo</code> triggers <code>progress</code> <code>Observable</code> twice so that it should tell the view to show the loader and then to hide it.</p>\n<pre><code class=\"language-kotlin\">@Test\nfun getRepoShouldShowProgress() {\n    vm.getRepo(\"any\", \"thing\")\n    progressObserver.assertValue(true)\n\n    testScheduler.triggerActions()\n    progressObserver.assertValueSequence(listOf(true, false))\n}\n</code></pre>\n<h1>Conclusion</h1>\n<p>As you can see, using <code>ViewModel</code>s and RxJava <code>Observable</code>s gives a very simple way to write unit tests for your code. I believe this great possibility will also encourage you to extract the business logic from the Android application components like Activities so that it can be tested without using instrumented tests or mocking the platform (e.g. with Robolectric).</p>","excerpt":"In my previous post I described how to implement injectable Android view models using Dagger and ViewModel library from Android Architecture…","frontmatter":{"slug":null,"title":"Testing Android ViewModels","description":null,"author":"azabost","tags":["android","kotlin","viewmodel","mvvm","unit tests"],"date":"2018-01-02T23:00:00.000Z","image":"/images/testing-android-viewmodels/stethoscope.jpg"},"timeToRead":5,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-01-03-testing-android-viewmodels.md"},"allMarkdownRemark":{"nodes":[{"frontmatter":{"author_id":"adam","avatar":"/images/members/adam_bar.jpg","bio":"The Web Guy @ Bright Inventions","name":"Adam Bar","web":"https://whatwebcando.today"}},{"frontmatter":{"author_id":"agnieszka_h","avatar":"/images/members/agnieszka_h.jpg","bio":"Sales Manager @ Bright Inventions","name":"Agnieszka Hayashida","web":null}},{"frontmatter":{"author_id":"agnieszka","avatar":"/images/members/agnieszka_olszewska.jpg","bio":"Fullstack developer","name":"Agnieszka Olszewska","web":null}},{"frontmatter":{"author_id":"olo","avatar":"/images/members/aleksander_wielgorski.jpeg","bio":"Software Engineer @ Bright Inventions","name":"Aleksander Wielgórski","web":null}},{"frontmatter":{"author_id":"alisa","avatar":"/images/members/alisa_kashytska.jpg","bio":"Product designer","name":"Alisa Kashytska","web":null}},{"frontmatter":{"author_id":"azabost","avatar":"/images/members/andrzej_zabost.jpg","bio":"Senior Android developer","name":"Andrzej Zabost","web":"https://azabost.com"}},{"frontmatter":{"author_id":"arturs","avatar":"/images/members/artur.jpg","bio":"iOS developer","name":"Artur Suliński","web":null}},{"frontmatter":{"author_id":"bartek k","avatar":"/images/members/bartek_krzyzanski.jpg","bio":"Backend developer","name":"Bartek Krzyżański","web":null}},{"frontmatter":{"author_id":"bartekr","avatar":"/images/members/bartek.jpg","bio":"iOS developer","name":"Bartek Rozwarski","web":null}},{"frontmatter":{"author_id":"bartosz","avatar":"/images/members/bartosz_szafran.jpg","bio":"Senior Frontend Developer","name":"Bartosz Szafran","web":null}},{"frontmatter":{"author_id":"daniel","avatar":"/images/members/daniel_makurat.jpg","bio":"Co-founder & Senior Backend developer","name":"Daniel Makurat","web":null}},{"frontmatter":{"author_id":"eliasz","avatar":"/images/members/eliasz.png","bio":"Software Engineer @ Bright Inventions","name":"Eliasz Sawicki","web":"http://eluss.github.io/"}},{"frontmatter":{"author_id":"fjablonski","avatar":"/images/members/filip_jablonski.jpg","bio":"Senior iOS developer","name":"Filip Jabłoński","web":null}},{"frontmatter":{"author_id":"grzesiek","avatar":"/images/members/grzegorz_ciesla.jpg","bio":"Software Developer","name":"Grzegorz Cieśla","web":null}},{"frontmatter":{"author_id":"ivan","avatar":"/images/members/ivan.jpg","bio":"Fullstack developer","name":"Ivan Menshykov","web":null}},{"frontmatter":{"author_id":"janek","avatar":"/images/members/janhanc.jpg","bio":"Frontend developer","name":"Jan Hanc","web":null}},{"frontmatter":{"author_id":"kwysocki","avatar":"/images/members/kamil.png","bio":"Software Engineer @ Bright Inventions","name":"Kamil Wysocki","web":"https://wysockikamil.com"}},{"frontmatter":{"author_id":"karoln","avatar":"/images/members/karol_nadratowski.jpg","bio":null,"name":"Karol Nadratowski","web":null}},{"frontmatter":{"author_id":"karol r","avatar":"/images/members/karol_rinc.jpg","bio":"Backend developer","name":"Karol Rinc","web":null}},{"frontmatter":{"author_id":"kasia","avatar":"/images/members/kasia_lukasiewicz.jpg","bio":"Senior Project Manager","name":"Kasia Łukasiewicz","web":null}},{"frontmatter":{"author_id":"kasia g","avatar":"/images/members/katarzyna_galka.jpg","bio":"Project manager","name":"Katarzyna Gałka","web":null}},{"frontmatter":{"author_id":"krzysiek h","avatar":"/images/members/krzysztof_hinc.jpg","bio":"Web developer","name":"Krzysiek Hinc","web":null}},{"frontmatter":{"author_id":"krzysiek","avatar":"/images/members/krzysztof_kaczmarek.jpg","bio":"Senior iOS Developer","name":"Krzysztof Kaczmarek","web":null}},{"frontmatter":{"author_id":"maciej","avatar":"/images/members/maciej_seleman.jpg","bio":"QA Specialist","name":"Maciej Seleman","web":null}},{"frontmatter":{"author_id":"magda","avatar":"/images/members/magda_sadowska.jpg","bio":"Office & HR Assistant","name":"Magda Sadowska","web":null}},{"frontmatter":{"author_id":"maja","avatar":"/images/members/maja_puta.jpg","bio":"Junior QA Specialist","name":"Maja Puta","web":null}},{"frontmatter":{"author_id":"marcink","avatar":"/images/members/marcin_kwiatkowski.jpg","bio":null,"name":"Marcin Kwiatkowski","web":null}},{"frontmatter":{"author_id":"mateusz","avatar":"/images/members/mateusz_klimczak.jpg","bio":"Technical leader & Project manager","name":"Mateusz Klimczak","web":null}},{"frontmatter":{"author_id":"mateuszklimek","avatar":"/images/members/mateuszklimek.png","bio":"Software Engineer @ Bright Inventions","name":"Mateusz Klimek","web":null}},{"frontmatter":{"author_id":"michal k","avatar":"/images/members/michal_koszalka.jpg","bio":"Senior Backend developer","name":"Michał Koszałka","web":null}},{"frontmatter":{"author_id":"michał","avatar":"/images/members/michal_wrobel.jpg","bio":"Senior Backend Developer at Bright Inventions","name":"Michał Wróbel","web":null}},{"frontmatter":{"author_id":"michal","avatar":"/images/members/michał_łukasiewicz.jpg","bio":"Co-founder & Senior iOS developer","name":"Michał Łukasiewicz","web":null}},{"frontmatter":{"author_id":"monika","avatar":"/images/members/monika.jpg","bio":"Software Developer @ Bright Inventions","name":"Monika Niegrzybowska","web":null}},{"frontmatter":{"author_id":"nikodem","avatar":"/images/members/nikodem_kalinowski.jpg","bio":"Web developer","name":"Nikodem Kalinowski","web":null}},{"frontmatter":{"author_id":"patryk","avatar":"/images/members/patryk_huzarski.jpg","bio":"Software Developer @ Bright Inventions","name":"Patryk Huzarski","web":null}},{"frontmatter":{"author_id":"patryk sz","avatar":"/images/members/patryk_szlagowski.jpg","bio":"Senior Backend developer","name":"Patryk Szlagowski","web":null}},{"frontmatter":{"author_id":"paweł","avatar":"/images/members/paweł_gutkowski.jpg","bio":"Fullstack Developer at Bright Inventions ","name":"Paweł Gutkowski","web":null}},{"frontmatter":{"author_id":"pawel","avatar":"/images/members/paweł_papkiewicz.jpg","bio":"Fullstack developer","name":"Paweł Papkiewicz","web":null}},{"frontmatter":{"author_id":"piotr","avatar":"/images/members/piotr_mionskowski.jpg","bio":"TDD fan eager to learn new things","name":"Piotr Mionskowski","web":"https://miensol.pl"}},{"frontmatter":{"author_id":"piotr_l","avatar":"/images/members/piotrl.png","bio":"Android Developer @ Bright Inventions","name":"Piotr Łupiński","web":"http://exp.flamaster2.com"}},{"frontmatter":{"author_id":"radek","avatar":"/images/members/radek_pieczątkiewicz.jpg","bio":"Android developer","name":"Radek Pieczątkiewicz","web":null}},{"frontmatter":{"author_id":"radeks","avatar":"/images/members/radoslaw.jpg","bio":"Software Engineer @ Bright Inventions","name":"Radosław Słowiński","web":null}},{"frontmatter":{"author_id":"rafal h","avatar":"/images/members/rafal_hoffman.jpg","bio":"Fullstack developer","name":"Rafał Hofman","web":null}},{"frontmatter":{"author_id":"sebastian","avatar":"/images/members/sebastian_sobczak.jpg","bio":"Junior Account Manager at Bright Inventions ","name":"Sebastian Sobczak","web":null}},{"frontmatter":{"author_id":"szymek","avatar":"/images/members/szymon_miloch.jpg","bio":"Android & Web developer","name":"Szymon Miloch","web":null}},{"frontmatter":{"author_id":"tomek","avatar":"/images/members/tomek.jpeg","bio":null,"name":"Tomasz Gęsior","web":null}},{"frontmatter":{"author_id":"ula","avatar":"/images/members/ula_stankiewicz.jpg","bio":"HR & Marketing Manager","name":"Ula Stankiewicz","web":null}},{"frontmatter":{"author_id":"wojciech","avatar":"/images/members/wojciech_baczyński.jpg","bio":"Fullstack developer","name":"Wojciech Baczyński","web":null}},{"frontmatter":{"author_id":"lukasz","avatar":"/images/members/lukasz_reszetow.jpg","bio":"Android developer","name":"Łukasz Reszetow","web":null}}]},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-01-03-testing-android-viewmodels.md"}}}