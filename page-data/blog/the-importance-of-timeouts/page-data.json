{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/the-importance-of-timeouts","result":{"data":{"markdownRemark":{"html":"<p><a href=\"https://en.wikipedia.org/wiki/Timeout_(computing)\">Timeouts</a> are not an exciting thing to talk about. They do not add immediately perceivable value. They are difficult to <del>guess</del> get right and force one to <a href=\"https://en.wikipedia.org/wiki/Byzantine_fault_tolerance#Byzantine_Generals.27_Problem\">consider problems that are hard to solve</a>. In fact, in my experience, the timeout is only ever considered when our software stops working or is about to. That is an enormous shame since, in my opinion, carefully applied timeouts can vastly improve software resiliency. </p>\n<p><img src=\"/images/the-importance-of-timeouts/man-clock.jpeg\" alt=\"Man with a wrist clock\"></p>\n<h2>An example application</h2>\n<p>Let us consider a simplistic example of a Spring Boot application generated using <a href=\"https://start.spring.io/\">Spring Initializr</a>. The application will only expose <a href=\"https://spring.io/guides/gs/actuator-service/\">actuator</a> API which by default define a health check endpoint. Our example will also have a mail module configured. </p>\n<p>The dependencies section of <code>build.gradle</code>:</p>\n<pre><code class=\"language-groovy\">dependencies {\n    compile('org.springframework.boot:spring-boot-starter-actuator')\n    compile('org.springframework.boot:spring-boot-starter-mail')\n    compile('org.springframework.boot:spring-boot-starter-web')\n    compile(\"org.jetbrains.kotlin:kotlin-stdlib-jre8:${kotlinVersion}\")\n    compile(\"org.jetbrains.kotlin:kotlin-reflect:${kotlinVersion}\")\n}\n</code></pre>\n<p>A typical health check endpoint verifies that application integration points work correctly. If the service talks to database then a connection is established and verified. A free disk space is checked. If the service sends emails through SMTP then a connection to a server is established.</p>\n<p>The health checks are auto discovered and enabled when you include Spring Boot Actuator. By default, <code>/health</code> path is used for the endpoint. The SMTP server host, port and credentials obviously need to be configured. At minimum host entry is required e.g. <code>spring.mail.host=localhost</code>. <em>For the debugging purpose one can disable actuator security with <code>management.security.enabled=false</code> to verify what health checks are performed by actuator.</em></p>\n<p>A last part of our example is the trivial application code:</p>\n<pre><code class=\"language-kotlin\">@SpringBootApplication\nclass Application {\n    companion object {\n        @JvmStatic\n        fun main(args: Array&#x3C;String>) {\n            SpringApplication.run(Application::class.java, *args)\n        }\n    }\n}\n</code></pre>\n<p>When you request <code>/health</code> the API will return response similar to:</p>\n<pre><code>HTTP/1.1 200 \nContent-Type: application/vnd.spring-boot.actuator.v1+json;charset=UTF-8\nDate: Mon, 23 Oct 2017 08:08:32 GMT\nTransfer-Encoding: chunked\nX-Application-Context: application\n\n{\n    \"diskSpace\": {\n        \"free\": 105755779072,\n        \"status\": \"UP\",\n        \"threshold\": 10485760,\n        \"total\": 499046809600\n    },\n    \"mail\": {\n        \"location\": \"localhost:-1\",\n        \"status\": \"UP\"\n    },\n    \"status\": \"UP\"\n}\n</code></pre>\n<p>An application health API, like the one in our example, is often hooked into external monitoring software. The monitor asks the target application about its health in regular intervals e.g. every 5 seconds. </p>\n<h2>Shooting yourself in the foot</h2>\n<p>The above example has an issue that can kill production server. More importantly, other metrics that are usually monitored e.g. CPU and memory usage will not warn about upcoming, dreadful service stall. The application will also not suffer from an enormous number of requests or emails being sent.</p>\n<p>Imagine that the health endpoint is checked every 5 seconds and that there is <strong>intermittent</strong> issue with the SMPT server. The health endpoint will <strong>rightfully</strong> try to connect to the SMTP server and from time to time respond with error. From my experience, when a health check is introduced it typically takes a while to tweak the monitor thresholds so that we get rid of false alarms. It is thus very easy to ignore intermittent errors when we think they are caused by too sensitive thresholds. However, the ignored errors can after a while cause our server to stop responding to <strong>any request</strong>. </p>\n<p><img src=\"/images/the-importance-of-timeouts/error.jpg\" alt=\"Man with a wrist clock\"></p>\n<p>Why this can happen you ask and I answer. <strong>There is no timeout configured!</strong></p>\n<p>The mail server health check uses <a href=\"https://docs.oracle.com/javaee/6/api/javax/mail/Service.html#connect(java.lang.String,%20java.lang.String)\"><code>javax.mail.Service.connect</code></a> under the hood. For a variety of reasons an attempt to establish a TCP connection can take arbitrary longer than usual. Unfortunately <strong>the default</strong> timeouts used by the <code>javax.mail.*</code> <a href=\"https://javaee.github.io/javamail/docs/api/com/sun/mail/smtp/package-summary.html\">are <strong>infinite</strong></a>. A thread that waits for the connection to be established cannot serve other requests even though it barely uses any CPU. The default maximum thread pool size used by embedded Tomcat in Spring Boot application is 200. Assuming that the blocked connection attempt happens twice an hour our application will stop working after 4 days.</p>\n<h2>Never use infinite timeouts</h2>\n<p>As you can see it is very easy to miss a need for a timeout to be configured. To be fair the <a href=\"https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-email.html\">Spring Boot documentation</a> states clearly:</p>\n<blockquote>\n<p>In particular, certain default timeout values are infinite and you may want to change that to avoid having a thread blocked by an unresponsive mail server:</p>\n<pre><code>spring.mail.properties.mail.smtp.connectiontimeout=5000\nspring.mail.properties.mail.smtp.timeout=3000\nspring.mail.properties.mail.smtp.writetimeout=5000\n</code></pre>\n</blockquote>\n<p>In my option any library or framework should either force the programmer to configure the timeout or have some <strong>sensible default</strong>. Unfortunately this is not always possible to introduce them later on without breaking changes hence we should <strong>check</strong> what are the timeouts used when calling any <strong>external service</strong>.</p>\n<h2>Timeouts needed everywhere</h2>\n<p>Imagine a controller action method that inserts a single row into a database. Let us further assume that the endpoint is called 50 times per second and it typically takes 100ms to complete. Things work well until we encounter an intermittent sloppiness of the database and now the insert takes 2 seconds to complete. The clients calling the API do not slow down. More request threads are blocked and <strong>more database connections</strong> are taken out of the pool. Soon as all database connections are in use and all other API endpoints start to fail. This is an example of cascading failure i.e. a problem in one component propagating to others. It is easier to avoid such issues when there is a timeout configured on the controller action and the interaction with the database. </p>\n<p>Every API endpoint <strong>should have a timeout configured</strong> if we want our services to be resilient. Unfortunately this rule is easy to neglect. Moreover, some frameworks do not even expose such ability. Even in the immensely popular Spring Mvc I could not find a way to set such timeout other than using an <a href=\"https://spring.io/guides/gs/async-method/\">async method</a>. Fortunately there are libraries e.g. <a href=\"https://github.com/Netflix/Hystrix\">Hystrix</a> that tackle that problem and can be integrated easily.</p>\n<p>Just to recap here is a short and incomplete list of cases where a timeout should be configured:</p>\n<ul>\n<li>a controller action </li>\n<li>a database query, statement</li>\n<li>a database pool interaction</li>\n<li>a thread pool interaction</li>\n<li>an API client e.g. HTTP, SOAP, SMTP</li>\n</ul>\n<p>I will describe how to deal with the cases in the following posts.</p>","excerpt":"Timeouts are not an exciting thing to talk about. They do not add immediately perceivable value. They are difficult to guess get right and…","frontmatter":{"slug":null,"title":"The importance of timeouts","description":null,"author":"piotr","tags":["server","request","timeout","query","resiliency","spring boot"],"date":"2017-10-22T22:00:00.000Z","image":"/images/the-importance-of-timeouts/man-clock.jpeg"},"timeToRead":5,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2017-10-23-the-importance-of-timeouts.md"},"allMarkdownRemark":{"nodes":[{"frontmatter":{"author_id":"adam","avatar":"/images/members/adam_bar.jpg","bio":"The Web Guy @ Bright Inventions","name":"Adam Bar","web":"https://whatwebcando.today"}},{"frontmatter":{"author_id":"agnieszka_h","avatar":"/images/members/agnieszka_h.jpg","bio":"Sales Manager @ Bright Inventions","name":"Agnieszka Hayashida","web":null}},{"frontmatter":{"author_id":"agnieszka","avatar":"/images/members/agnieszka_olszewska.jpg","bio":"Fullstack developer","name":"Agnieszka Olszewska","web":null}},{"frontmatter":{"author_id":"olo","avatar":"/images/members/aleksander_wielgorski.jpeg","bio":"Software Engineer @ Bright Inventions","name":"Aleksander Wielgórski","web":null}},{"frontmatter":{"author_id":"alisa","avatar":"/images/members/alisa_kashytska.jpg","bio":"Product designer","name":"Alisa Kashytska","web":null}},{"frontmatter":{"author_id":"azabost","avatar":"/images/members/andrzej_zabost.jpg","bio":"Senior Android developer","name":"Andrzej Zabost","web":"https://azabost.com"}},{"frontmatter":{"author_id":"arturs","avatar":"/images/members/artur.jpg","bio":"iOS developer","name":"Artur Suliński","web":null}},{"frontmatter":{"author_id":"bartek k","avatar":"/images/members/bartek_krzyzanski.jpg","bio":"Backend developer","name":"Bartek Krzyżański","web":null}},{"frontmatter":{"author_id":"bartekr","avatar":"/images/members/bartek.jpg","bio":"iOS developer","name":"Bartek Rozwarski","web":null}},{"frontmatter":{"author_id":"bartosz","avatar":"/images/members/bartosz_szafran.jpg","bio":"Senior Frontend Developer","name":"Bartosz Szafran","web":null}},{"frontmatter":{"author_id":"daniel","avatar":"/images/members/daniel_makurat.jpg","bio":"Co-founder & Senior Backend developer","name":"Daniel Makurat","web":null}},{"frontmatter":{"author_id":"eliasz","avatar":"/images/members/eliasz.png","bio":"Software Engineer @ Bright Inventions","name":"Eliasz Sawicki","web":"http://eluss.github.io/"}},{"frontmatter":{"author_id":"fjablonski","avatar":"/images/members/filip_jablonski.jpg","bio":"Senior iOS developer","name":"Filip Jabłoński","web":null}},{"frontmatter":{"author_id":"grzesiek","avatar":"/images/members/grzegorz_ciesla.jpg","bio":"Software Developer","name":"Grzegorz Cieśla","web":null}},{"frontmatter":{"author_id":"ivan","avatar":"/images/members/ivan.jpg","bio":"Fullstack developer","name":"Ivan Menshykov","web":null}},{"frontmatter":{"author_id":"janek","avatar":"/images/members/janhanc.jpg","bio":"Frontend developer","name":"Jan Hanc","web":null}},{"frontmatter":{"author_id":"kwysocki","avatar":"/images/members/kamil.png","bio":"Software Engineer @ Bright Inventions","name":"Kamil Wysocki","web":"https://wysockikamil.com"}},{"frontmatter":{"author_id":"karoln","avatar":"/images/members/karol_nadratowski.jpg","bio":null,"name":"Karol Nadratowski","web":null}},{"frontmatter":{"author_id":"karol r","avatar":"/images/members/karol_rinc.jpg","bio":"Backend developer","name":"Karol Rinc","web":null}},{"frontmatter":{"author_id":"kasia","avatar":"/images/members/kasia_lukasiewicz.jpg","bio":"Senior Project Manager","name":"Kasia Łukasiewicz","web":null}},{"frontmatter":{"author_id":"kasia g","avatar":"/images/members/katarzyna_galka.jpg","bio":"Project manager","name":"Katarzyna Gałka","web":null}},{"frontmatter":{"author_id":"krzysiek h","avatar":"/images/members/krzysztof_hinc.jpg","bio":"Web developer","name":"Krzysiek Hinc","web":null}},{"frontmatter":{"author_id":"krzysiek","avatar":"/images/members/krzysztof_kaczmarek.jpg","bio":"Senior iOS Developer","name":"Krzysztof Kaczmarek","web":null}},{"frontmatter":{"author_id":"maciej","avatar":"/images/members/maciej_seleman.jpg","bio":"QA Specialist","name":"Maciej Seleman","web":null}},{"frontmatter":{"author_id":"magda","avatar":"/images/members/magda_sadowska.jpg","bio":"Office & HR Assistant","name":"Magda Sadowska","web":null}},{"frontmatter":{"author_id":"maja","avatar":"/images/members/maja_puta.jpg","bio":"Junior QA Specialist","name":"Maja Puta","web":null}},{"frontmatter":{"author_id":"marcink","avatar":"/images/members/marcin_kwiatkowski.jpg","bio":null,"name":"Marcin Kwiatkowski","web":null}},{"frontmatter":{"author_id":"mateusz","avatar":"/images/members/mateusz_klimczak.jpg","bio":"Technical leader & Project manager","name":"Mateusz Klimczak","web":null}},{"frontmatter":{"author_id":"mateuszklimek","avatar":"/images/members/mateuszklimek.png","bio":"Software Engineer @ Bright Inventions","name":"Mateusz Klimek","web":null}},{"frontmatter":{"author_id":"michal k","avatar":"/images/members/michal_koszalka.jpg","bio":"Senior Backend developer","name":"Michał Koszałka","web":null}},{"frontmatter":{"author_id":"michał","avatar":"/images/members/michal_wrobel.jpg","bio":"Senior Backend Developer at Bright Inventions","name":"Michał Wróbel","web":null}},{"frontmatter":{"author_id":"michal","avatar":"/images/members/michał_łukasiewicz.jpg","bio":"Co-founder & Senior iOS developer","name":"Michał Łukasiewicz","web":null}},{"frontmatter":{"author_id":"monika","avatar":"/images/members/monika.jpg","bio":"Software Developer @ Bright Inventions","name":"Monika Niegrzybowska","web":null}},{"frontmatter":{"author_id":"nikodem","avatar":"/images/members/nikodem_kalinowski.jpg","bio":"Web developer","name":"Nikodem Kalinowski","web":null}},{"frontmatter":{"author_id":"patryk","avatar":"/images/members/patryk_huzarski.jpg","bio":"Software Developer @ Bright Inventions","name":"Patryk Huzarski","web":null}},{"frontmatter":{"author_id":"patryk sz","avatar":"/images/members/patryk_szlagowski.jpg","bio":"Senior Backend developer","name":"Patryk Szlagowski","web":null}},{"frontmatter":{"author_id":"paweł","avatar":"/images/members/paweł_gutkowski.jpg","bio":"Fullstack Developer at Bright Inventions ","name":"Paweł Gutkowski","web":null}},{"frontmatter":{"author_id":"pawel","avatar":"/images/members/paweł_papkiewicz.jpg","bio":"Fullstack developer","name":"Paweł Papkiewicz","web":null}},{"frontmatter":{"author_id":"piotr","avatar":"/images/members/piotr_mionskowski.jpg","bio":"TDD fan eager to learn new things","name":"Piotr Mionskowski","web":"https://miensol.pl"}},{"frontmatter":{"author_id":"piotr_l","avatar":"/images/members/piotrl.png","bio":"Android Developer @ Bright Inventions","name":"Piotr Łupiński","web":"http://exp.flamaster2.com"}},{"frontmatter":{"author_id":"radek","avatar":"/images/members/radek_pieczątkiewicz.jpg","bio":"Android developer","name":"Radek Pieczątkiewicz","web":null}},{"frontmatter":{"author_id":"radeks","avatar":"/images/members/radoslaw.jpg","bio":"Software Engineer @ Bright Inventions","name":"Radosław Słowiński","web":null}},{"frontmatter":{"author_id":"rafal h","avatar":"/images/members/rafal_hoffman.jpg","bio":"Fullstack developer","name":"Rafał Hofman","web":null}},{"frontmatter":{"author_id":"sebastian","avatar":"/images/members/sebastian_sobczak.jpg","bio":"Junior Account Manager at Bright Inventions ","name":"Sebastian Sobczak","web":null}},{"frontmatter":{"author_id":"szymek","avatar":"/images/members/szymon_miloch.jpg","bio":"Android & Web developer","name":"Szymon Miloch","web":null}},{"frontmatter":{"author_id":"tomek","avatar":"/images/members/tomek.jpeg","bio":null,"name":"Tomasz Gęsior","web":null}},{"frontmatter":{"author_id":"ula","avatar":"/images/members/ula_stankiewicz.jpg","bio":"HR & Marketing Manager","name":"Ula Stankiewicz","web":null}},{"frontmatter":{"author_id":"wojciech","avatar":"/images/members/wojciech_baczyński.jpg","bio":"Fullstack developer","name":"Wojciech Baczyński","web":null}},{"frontmatter":{"author_id":"lukasz","avatar":"/images/members/lukasz_reszetow.jpg","bio":"Android developer","name":"Łukasz Reszetow","web":null}}]},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2017-10-23-the-importance-of-timeouts.md"}}}