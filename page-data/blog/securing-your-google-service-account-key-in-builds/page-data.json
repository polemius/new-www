{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/securing-your-google-service-account-key-in-builds","result":{"data":{"markdownRemark":{"html":"<p>Establishing a reliable continuous delivery and deployment process is often very important as it might greatly reduce the length of time needed for the validation and verification of the software product. This is also true for Android projects, especially the ones aimed at short time to market.</p>\n<p>For me, one of the most crucial time savers is the <a href=\"https://github.com/Triple-T/gradle-play-publisher\">gradle-play-publisher</a> plugin, which allows me to publish the APKs as soon as the build is finished. However, you need the Google service account for that.</p>\n<h1>With great power comes great responsibility</h1>\n<p>The Google service account is an account that might be used by your applications to access all the Google APIs, including the ones for Google Play publishing (<a href=\"https://developers.google.com/android-publisher/#publishing\">Publishing API</a>). This API allows for example to:</p>\n<ul>\n<li>publish the APK (obviously)</li>\n<li>update the app listing (title, descriptions, images, videos, recent changes)</li>\n<li>change contact information (e-mail, phone number, website)</li>\n</ul>\n<p>While granting this account the <a href=\"https://github.com/Triple-T/gradle-play-publisher#google-play-service-account\">required permissions</a>, you cannot choose which particular apps it can access - it's either all or nothing. So if you have more than one application on your Google developer account, the service account will be able to reach them all.</p>\n<p>Bearing this in mind, you should always protect the service account from abuse. The <a href=\"https://developers.google.com/android-publisher/api_usage\">documentation</a> also does warn you:</p>\n<blockquote>\n<p>We recommend not giving third parties access to any service accounts you may create. We especially recommend not giving access to any private keys for your service account. Doing so provides anonymous access to your account that can be shared with anyone.</p>\n</blockquote>\n<p><img src=\"/images/securing-your-google-service-account-key-in-builds/padlock-597495_1920.jpg\" alt=\"Padlock\">{: .center-image}</p>\n<h1>Automatic build deployment</h1>\n<p>If you are going to use the Publishing API in your builds, you definitely should take the appropriate measures to keep the service account key secure. Depending on your company policies (e.g. repositories access), the size of your team, your customer needs and policies, you might consider:</p>\n<ul>\n<li>not storing the key in the repository</li>\n<li>storing the key in a password-protected archive in the repository</li>\n<li>storing the key in a separate repository</li>\n<li>not storing the key at all (wait, what? see the example below)</li>\n<li>... etc.</li>\n</ul>\n<h1>Example</h1>\n<p>So how you can <em>not store the key at all</em>? Well, I have lied a bit. You must store it somewhere, but this example will show you how to store it as a secret value on a build server instead of a repository. This way you don't have to protect the repository itself, but the build server instead. Is it easier? It depends. But it's just one of the methods you can choose.</p>\n<h3>Setting a secret value</h3>\n<p>Most of the automation servers like Jenkins or TeamCity have the ability to store a secret value, which you can use during the build. Whether it is really secure depends on the particular software you use, the build script (which may be printing the secret value to the build logs for example) and the access you give other people to the infrastructure and build configuration.</p>\n<p>In this example, the secret value is stored on a TeamCity server and it will be available to the build in an environment variable.</p>\n<p><img src=\"/images/securing-your-google-service-account-key-in-builds/tc_secret_value.png\" alt=\"TeamCity secret value\">{: .center-image}</p>\n<h3>Reading the key in a build</h3>\n<p>There are plenty of ways you can read the environment variable during the build. This example uses a Gradle task to generate a file containing the key needed by the <code>gradle-play-publisher</code> plugin before the publication.</p>\n<pre><code class=\"language-groovy\">apply plugin: 'com.android.application'\napply plugin: 'com.github.triplet.play'\n\nclass GenerateGooglePlayDeploymentJsonFile extends DefaultTask {\n    File jsonFile\n\n    @TaskAction\n    def generate() {\n        def envVar = \"GOOGLE_API_JSON\"\n        def json = System.getenv(envVar)\n        if (json) {\n            jsonFile.write(json)\n        } else {\n            logger.log(LogLevel.ERROR, \"You must use $envVar for Google Play publishing\")\n        }\n    }\n}\n\nandroid {\n\n    final googlePlayDeploymentJsonFile = new File(\"google_play_api.json\")\n\n    task generateGooglePlayDeploymentJsonFile(type: GenerateGooglePlayDeploymentJsonFile) {\n        jsonFile = googlePlayDeploymentJsonFile\n    }\n\n    playAccountConfigs {\n        defaultAccountConfig {\n            jsonFile = googlePlayDeploymentJsonFile\n        }\n    }\n    play {\n        track = 'beta'\n    }\n    defaultConfig {\n        playAccountConfig = playAccountConfigs.defaultAccountConfig\n        // other config ...\n    }\n    buildTypes {\n        release {\n            // config ...\n        }\n        debug {\n            // config ...\n        }\n    }\n    productFlavors {\n        prod {\n            // config ...\n        }\n        dev {\n            // config ...\n        }\n    }\n    project.afterEvaluate {\n        project.tasks.findAll {\n            it.name.startsWith(\"generate\") &#x26;amp;&#x26;amp; it.name.endsWith(\"PlayResources\")\n        }.forEach({\n            logger.log(LogLevel.WARN, \"Configuring Google Play deployment JSON file for task: $it\")\n            it.dependsOn generateGooglePlayDeploymentJsonFile\n        })\n    }\n    // other config ...\n}\n</code></pre>\n<p>The way it works is pretty straightforward:</p>\n<ol>\n<li>\n<p>Find some tasks generated by the publishing plugin.</p>\n<ul>\n<li>The generated tasks names consist of the names of your release build variants. In this example there are: <code>devRelease</code> and <code>prodRelease</code>, which produce (among the others): <code>generateDevReleasePlayResources</code> and <code>generateProdReleasePlayResources</code>.</li>\n</ul>\n</li>\n<li>Make the generated tasks depend on the <code>generateGooglePlayDeploymentJsonFile</code> task, which expects the Google service account key (in JSON format) in the environment variable and saves it to a specified file.</li>\n<li>Configure the publishing plugin to use the generated file.</li>\n</ol>\n<p>Of course this simple script might be further improved and I encourage you to do it on your own.</p>\n<h3>Publishing the app</h3>\n<p>The Gradle tasks used for the publication in this example are: <code>publishApkDevRelease</code> and <code>publishApkProdRelease</code>. Publishing the APKs with them is as simple as running these tasks like this:</p>\n<pre><code class=\"language-bash\">gradle publishApkProdRelease\n</code></pre>\n<p>And you can see in the logs that it works:</p>\n<pre><code>[10:59:52][Step 1/1] Configuring Google Play deployment JSON file for task: task ':app:generateDevReleasePlayResources'\n[10:59:52][Step 1/1] Configuring Google Play deployment JSON file for task: task ':app:generateProdReleasePlayResources'\n...\n[11:00:50][Step 1/1] :app:assembleProdRelease\n[11:00:50][Step 1/1] :app:generateGooglePlayDeploymentJsonFile\n[11:00:50][Step 1/1] :app:generateProdReleasePlayResources\n[11:00:58][Step 1/1] :app:publishApkProdRelease\n</code></pre>\n<h3>Throw the key away</h3>\n<p>Now, having this process configured, you can safely delete the Google service account key file, so no one will ever abuse it (unless they somehow read it from the build server, which is your only worry now). In case your server dies and you lose the key, you can just invalidate it and generate another one in the <a href=\"https://console.developers.google.com\">Google APIs Console</a>.</p>\n<h1>Summary</h1>\n<p>Protecting the service account key may be challenging, but it's very important and worth considering. You should assess the options you have, their pros and cons, the risks and profits. Keep in mind that any level of protection is better than no protection at all.</p>","excerpt":"Establishing a reliable continuous delivery and deployment process is often very important as it might greatly reduce the length of time…","frontmatter":{"slug":null,"title":"Securing your Google service account key in builds","description":null,"author":"azabost","tags":["android","build"],"date":"2017-10-05T22:00:00.000Z","image":"/images/securing-your-google-service-account-key-in-builds/padlock-597495_1920.jpg"},"timeToRead":5,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2017-10-06-securing-your-google-service-account-key-in-builds.md"},"allMarkdownRemark":{"nodes":[{"frontmatter":{"author_id":"adam","avatar":"/images/members/adam_bar.jpg","bio":"The Web Guy @ Bright Inventions","name":"Adam Bar","web":"https://whatwebcando.today"}},{"frontmatter":{"author_id":"agnieszka_h","avatar":"/images/members/agnieszka_h.jpg","bio":"Sales Manager @ Bright Inventions","name":"Agnieszka Hayashida","web":null}},{"frontmatter":{"author_id":"agnieszka","avatar":"/images/members/agnieszka_olszewska.jpg","bio":"Fullstack developer","name":"Agnieszka Olszewska","web":null}},{"frontmatter":{"author_id":"olo","avatar":"/images/members/aleksander_wielgorski.jpeg","bio":"Software Engineer @ Bright Inventions","name":"Aleksander Wielgórski","web":null}},{"frontmatter":{"author_id":"alisa","avatar":"/images/members/alisa_kashytska.jpg","bio":"Product designer","name":"Alisa Kashytska","web":null}},{"frontmatter":{"author_id":"azabost","avatar":"/images/members/andrzej_zabost.jpg","bio":"Senior Android developer","name":"Andrzej Zabost","web":"https://azabost.com"}},{"frontmatter":{"author_id":"arturs","avatar":"/images/members/artur.jpg","bio":"iOS developer","name":"Artur Suliński","web":null}},{"frontmatter":{"author_id":"bartek k","avatar":"/images/members/bartek_krzyzanski.jpg","bio":"Backend developer","name":"Bartek Krzyżański","web":null}},{"frontmatter":{"author_id":"bartekr","avatar":"/images/members/bartek.jpg","bio":"iOS developer","name":"Bartek Rozwarski","web":null}},{"frontmatter":{"author_id":"bartosz","avatar":"/images/members/bartosz_szafran.jpg","bio":"Senior Frontend Developer","name":"Bartosz Szafran","web":null}},{"frontmatter":{"author_id":"daniel","avatar":"/images/members/daniel_makurat.jpg","bio":"Co-founder & Senior Backend developer","name":"Daniel Makurat","web":null}},{"frontmatter":{"author_id":"eliasz","avatar":"/images/members/eliasz.png","bio":"Software Engineer @ Bright Inventions","name":"Eliasz Sawicki","web":"http://eluss.github.io/"}},{"frontmatter":{"author_id":"fjablonski","avatar":"/images/members/filip_jablonski.jpg","bio":"Senior iOS developer","name":"Filip Jabłoński","web":null}},{"frontmatter":{"author_id":"grzesiek","avatar":"/images/members/grzegorz_ciesla.jpg","bio":"Software Developer","name":"Grzegorz Cieśla","web":null}},{"frontmatter":{"author_id":"ivan","avatar":"/images/members/ivan.jpg","bio":"Fullstack developer","name":"Ivan Menshykov","web":null}},{"frontmatter":{"author_id":"janek","avatar":"/images/members/janhanc.jpg","bio":"Frontend developer","name":"Jan Hanc","web":null}},{"frontmatter":{"author_id":"kwysocki","avatar":"/images/members/kamil.png","bio":"Software Engineer @ Bright Inventions","name":"Kamil Wysocki","web":"https://wysockikamil.com"}},{"frontmatter":{"author_id":"karoln","avatar":"/images/members/karol_nadratowski.jpg","bio":null,"name":"Karol Nadratowski","web":null}},{"frontmatter":{"author_id":"karol r","avatar":"/images/members/karol_rinc.jpg","bio":"Backend developer","name":"Karol Rinc","web":null}},{"frontmatter":{"author_id":"kasia","avatar":"/images/members/kasia_lukasiewicz.jpg","bio":"Senior Project Manager","name":"Kasia Łukasiewicz","web":null}},{"frontmatter":{"author_id":"kasia g","avatar":"/images/members/katarzyna_galka.jpg","bio":"Project manager","name":"Katarzyna Gałka","web":null}},{"frontmatter":{"author_id":"krzysiek h","avatar":"/images/members/krzysztof_hinc.jpg","bio":"Web developer","name":"Krzysiek Hinc","web":null}},{"frontmatter":{"author_id":"krzysiek","avatar":"/images/members/krzysztof_kaczmarek.jpg","bio":"Senior iOS Developer","name":"Krzysztof Kaczmarek","web":null}},{"frontmatter":{"author_id":"maciej","avatar":"/images/members/maciej_seleman.jpg","bio":"QA Specialist","name":"Maciej Seleman","web":null}},{"frontmatter":{"author_id":"magda","avatar":"/images/members/magda_sadowska.jpg","bio":"Office & HR Assistant","name":"Magda Sadowska","web":null}},{"frontmatter":{"author_id":"maja","avatar":"/images/members/maja_puta.jpg","bio":"Junior QA Specialist","name":"Maja Puta","web":null}},{"frontmatter":{"author_id":"marcink","avatar":"/images/members/marcin_kwiatkowski.jpg","bio":null,"name":"Marcin Kwiatkowski","web":null}},{"frontmatter":{"author_id":"mateusz","avatar":"/images/members/mateusz_klimczak.jpg","bio":"Technical leader & Project manager","name":"Mateusz Klimczak","web":null}},{"frontmatter":{"author_id":"mateuszklimek","avatar":"/images/members/mateuszklimek.png","bio":"Software Engineer @ Bright Inventions","name":"Mateusz Klimek","web":null}},{"frontmatter":{"author_id":"michal k","avatar":"/images/members/michal_koszalka.jpg","bio":"Senior Backend developer","name":"Michał Koszałka","web":null}},{"frontmatter":{"author_id":"michał","avatar":"/images/members/michal_wrobel.jpg","bio":"Senior Backend Developer at Bright Inventions","name":"Michał Wróbel","web":null}},{"frontmatter":{"author_id":"michal","avatar":"/images/members/michał_łukasiewicz.jpg","bio":"Co-founder & Senior iOS developer","name":"Michał Łukasiewicz","web":null}},{"frontmatter":{"author_id":"monika","avatar":"/images/members/monika.jpg","bio":"Software Developer @ Bright Inventions","name":"Monika Niegrzybowska","web":null}},{"frontmatter":{"author_id":"nikodem","avatar":"/images/members/nikodem_kalinowski.jpg","bio":"Web developer","name":"Nikodem Kalinowski","web":null}},{"frontmatter":{"author_id":"patryk","avatar":"/images/members/patryk_huzarski.jpg","bio":"Software Developer @ Bright Inventions","name":"Patryk Huzarski","web":null}},{"frontmatter":{"author_id":"patryk sz","avatar":"/images/members/patryk_szlagowski.jpg","bio":"Senior Backend developer","name":"Patryk Szlagowski","web":null}},{"frontmatter":{"author_id":"paweł","avatar":"/images/members/paweł_gutkowski.jpg","bio":"Fullstack Developer at Bright Inventions ","name":"Paweł Gutkowski","web":null}},{"frontmatter":{"author_id":"pawel","avatar":"/images/members/paweł_papkiewicz.jpg","bio":"Fullstack developer","name":"Paweł Papkiewicz","web":null}},{"frontmatter":{"author_id":"piotr","avatar":"/images/members/piotr_mionskowski.jpg","bio":"TDD fan eager to learn new things","name":"Piotr Mionskowski","web":"https://miensol.pl"}},{"frontmatter":{"author_id":"piotr_l","avatar":"/images/members/piotrl.png","bio":"Android Developer @ Bright Inventions","name":"Piotr Łupiński","web":"http://exp.flamaster2.com"}},{"frontmatter":{"author_id":"radek","avatar":"/images/members/radek_pieczątkiewicz.jpg","bio":"Android developer","name":"Radek Pieczątkiewicz","web":null}},{"frontmatter":{"author_id":"radeks","avatar":"/images/members/radoslaw.jpg","bio":"Software Engineer @ Bright Inventions","name":"Radosław Słowiński","web":null}},{"frontmatter":{"author_id":"rafal h","avatar":"/images/members/rafal_hoffman.jpg","bio":"Fullstack developer","name":"Rafał Hofman","web":null}},{"frontmatter":{"author_id":"sebastian","avatar":"/images/members/sebastian_sobczak.jpg","bio":"Junior Account Manager at Bright Inventions ","name":"Sebastian Sobczak","web":null}},{"frontmatter":{"author_id":"szymek","avatar":"/images/members/szymon_miloch.jpg","bio":"Android & Web developer","name":"Szymon Miloch","web":null}},{"frontmatter":{"author_id":"tomek","avatar":"/images/members/tomek.jpeg","bio":null,"name":"Tomasz Gęsior","web":null}},{"frontmatter":{"author_id":"ula","avatar":"/images/members/ula_stankiewicz.jpg","bio":"HR & Marketing Manager","name":"Ula Stankiewicz","web":null}},{"frontmatter":{"author_id":"wojciech","avatar":"/images/members/wojciech_baczyński.jpg","bio":"Fullstack developer","name":"Wojciech Baczyński","web":null}},{"frontmatter":{"author_id":"lukasz","avatar":"/images/members/lukasz_reszetow.jpg","bio":"Android developer","name":"Łukasz Reszetow","web":null}}]},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2017-10-06-securing-your-google-service-account-key-in-builds.md"}}}