{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/microbenchmarking-on-android","result":{"data":{"markdownRemark":{"html":"<p>Since Kotlin becomes more and more popular, especially amongst Android developers (and it's <a href=\"https://android-developers.googleblog.com/2017/05/android-announces-support-for-kotlin.html\">officially supported by Google</a>), some people decided to compare its runtime performance with Java. After reading a few articles I wanted to test it myself and now I'm ready to share some of my observations and experiences.</p>\n<h1>What is it about?</h1>\n<p>Microbenchmarking is just micro-scale benchmarking :-) It's about measuring the performance of something really \"small\" that may take just micro- or nanoseconds, like calling a function or iterating over a collection.</p>\n<p>I really recommend to read <a href=\"https://github.com/google/caliper/wiki/JavaMicrobenchmarks\">this wiki page on GitHub</a> as it summarizes a few very important aspects of microbenchmarking, including its fallibility and some possible reasons why you could ever consider doing it. It also explains why you should actually avoid writing microbenchmarks as there are only a few reasonable excuses for doing it (mostly when you develop a performance-critical library or framework).</p>\n<p><img src=\"/images/microbenchmarking-on-android/hourglass-2910948_1280.jpg\" alt=\"Hourglass\">{: .center-image}</p>\n<h1>How do I start?</h1>\n<p>Writing a microbenchmark can be as simple as running some piece of code in a loop and measuring the time. You can also use one of the existing frameworks which have some useful features like the possibility to easily configure the way your benchmarks will be executed.</p>\n<p>Unfortunately, if you are willing to perform the tests on Android, you can't use probably the most advanced library, <a href=\"http://openjdk.java.net/projects/code-tools/jmh/\">JMH</a>, as it uses some part of the Java API not available in Android API. This fact might discourage you from using Android platform for your benchmarks but you should bear in mind ART and Dalvik have significantly different characteristics from the JVM so optimizing code for JVM may be pessimizing it for Android (take a look at <a href=\"https://github.com/google/gson/commit/084047d80b582317f382536604373cafa14583a4\">this commit in Gson library</a>).</p>\n<h2>Manual measurements</h2>\n<p>The simplest way to measure the execution time of some code block is to call it large number of times in a loop like below:</p>\n<pre><code class=\"language-kotlin\">fun measure() {\n    val reps: Long = 1_000_000\n\n    var sum: Long = 0L\n\n    val callFuncBegin = System.nanoTime()\n\n    for (i in 0 until reps) {\n        sum += addConst(i)\n    }\n\n    val callFuncEnd = System.nanoTime()\n    val callFuncDiff = Math.abs(callFuncEnd - callFuncBegin)\n\n    println(sum)\n\n    val result = callFuncDiff / reps\n\n    println(result)\n}\n\nfun addConst(number: Long): Long {\n    return 5 + number\n}\n</code></pre>\n<p>In this example we benchmark the <code>addConst</code> function. If you are new to microbenchmarking, I bet you have a few questions.</p>\n<p>First of all, we need multiple <code>addConst</code> calls for a few reasons, for example because <code>System.nanoTime()</code> doesn't really need to be that accurate as you might think. The documentation says it clearly:</p>\n<blockquote>\n<p>This method provides nanosecond precision, but not necessarily nanosecond resolution (that is, how frequently the value changes) - no guarantees are made except that the resolution is at least as good as that of currentTimeMillis().</p>\n</blockquote>\n<p>Another reason is to get more confident results as the test environment (the smartphone) is very complex and it surely will take different amount of time for each execution.</p>\n<p>It is also important to keep in mind that <code>System.nanoTime()</code> might be relatively expensive in terms of execution time so we definitely should NOT put it inside the same loop as the measured function, unless all we want to measure is <code>System.nanoTime()</code> itself (been there, done that :-) ). So this is another reason why we need to call the desired function multiple times - to compensate <code>System.nanoTime()</code> overhead.</p>\n<p>Another aspect is that we need a function that has some observable effects, e.g. returning a result that is accumulated and then printed out. Otherwise, the compiler could cut out the code that was meant to be measured (see: <a href=\"https://github.com/google/caliper/wiki/JavaMicrobenchmarkReviewCriteria\">Could a compiler possibly optimize your benchmark away?</a>).</p>\n<h2>Spanner</h2>\n<p>Another way to benchmark the code is to use a dedicated framework like <a href=\"https://github.com/cmelchior/spanner\">Spanner</a>. It's an Android-oriented, <a href=\"https://github.com/google/caliper\">Caliper</a>-like library which can make this task easier. Despite its alpha-ish state, it's quite usable and worth trying out.</p>\n<p>Putting configuration matters aside, the benchmark function may look like this:</p>\n<pre><code class=\"language-kotlin\">@Benchmark\nfun addConstTest(reps: Long): Long {\n    var sum = 0L\n    for (i in 0 until reps) {\n        sum += addConst(i)\n    }\n    return sum\n}\n\nfun addConst(number: Long): Long {\n    return 5 + number\n}\n</code></pre>\n<p>As you can see, the framework gives us the required repetitions count as a parameter and it's our job to actually run the code in a loop.</p>\n<p><em>Side note: the current Spanner version (as of Feb 2, 2018) requires benchmark classes' and methods' modifiers to be exacly <code>java.lang.reflect.Modifier.PUBLIC</code> so you can't run final-by-default Kotlin code without additional <code>open</code> modifier. That's why I use my <a href=\"https://github.com/azabost/spanner\">forked version</a> with this behavior changed accordingly.</em></p>\n<p>Spanner can also upload your benchmark results to <a href=\"https://microbenchmarks.appspot.com\">https://microbenchmarks.appspot.com</a> either anonymously or with a given API key.</p>\n<p><img src=\"/images/microbenchmarking-on-android/spanner-result.png\" alt=\"Spanner results\">{: .center-image}</p>\n<h1>What could possibly go wrong?</h1>\n<p>It's very easy to get horribly misleading results, especially if you don't follow some rules when writing microbenchmarks. For example, <a href=\"http://www.oracle.com/technetwork/articles/java/architect-benchmarking-2266277.html\">this article</a> by Julien Page shows how benchmarks may be optimized by the JVM so that the results become meaningless. A few criteria of a good benchmark have also been defined on <a href=\"https://github.com/google/caliper/wiki/JavaMicrobenchmarkReviewCriteria\">this Caliper wiki page</a>. And in <a href=\"https://github.com/melix/jmh-gradle-example/blob/master/src/jmh/java/org/openjdk/jmh/samples/JMHSample_11_Loops.java\">this example</a> Cédric Champeau proves why it's so important to use the right tool for measurements (like JMH).</p>\n<p>Of course there are more issues that may happen, e.g.:</p>\n<ul>\n<li>garbage collection occurring during the measurements,</li>\n<li>temporarily increased CPU usage by other apps,</li>\n<li>JIT compiler making your code run faster each time,</li>\n<li>unavoidable CPU throttling.</li>\n</ul>\n<h1>Conclusion</h1>\n<p>Microbenchmarking is an interesting topic and I'm glad I could practice it myself and learn about it. As I've already mentioned, it's not something you should do on your daily basis, but still, I think it's worth reading about it and trying it out just to expand your horizons.</p>","excerpt":"Since Kotlin becomes more and more popular, especially amongst Android developers (and it's officially supported by Google), some people…","frontmatter":{"slug":null,"title":"Microbenchmarking on Android","description":null,"author":"azabost","tags":["android","java","kotlin","benchmark"],"date":"2018-02-07T23:00:00.000Z","image":"/images/microbenchmarking-on-android/hourglass-2910948_1280.jpg"},"timeToRead":5,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-02-08-microbenchmarking-on-android.md"},"allMarkdownRemark":{"nodes":[{"frontmatter":{"author_id":"adam","avatar":"/images/members/adam_bar.jpg","bio":"The Web Guy @ Bright Inventions","name":"Adam Bar","web":"https://whatwebcando.today"}},{"frontmatter":{"author_id":"agnieszka_h","avatar":"/images/members/agnieszka_h.jpg","bio":"Sales Manager @ Bright Inventions","name":"Agnieszka Hayashida","web":null}},{"frontmatter":{"author_id":"agnieszka","avatar":"/images/members/agnieszka_olszewska.jpg","bio":"Fullstack developer","name":"Agnieszka Olszewska","web":null}},{"frontmatter":{"author_id":"olo","avatar":"/images/members/aleksander_wielgorski.jpeg","bio":"Software Engineer @ Bright Inventions","name":"Aleksander Wielgórski","web":null}},{"frontmatter":{"author_id":"alisa","avatar":"/images/members/alisa_kashytska.jpg","bio":"Product designer","name":"Alisa Kashytska","web":null}},{"frontmatter":{"author_id":"azabost","avatar":"/images/members/andrzej_zabost.jpg","bio":"Senior Android developer","name":"Andrzej Zabost","web":"https://azabost.com"}},{"frontmatter":{"author_id":"arturs","avatar":"/images/members/artur.jpg","bio":"iOS developer","name":"Artur Suliński","web":null}},{"frontmatter":{"author_id":"bartek k","avatar":"/images/members/bartek_krzyzanski.jpg","bio":"Backend developer","name":"Bartek Krzyżański","web":null}},{"frontmatter":{"author_id":"bartekr","avatar":"/images/members/bartek.jpg","bio":"iOS developer","name":"Bartek Rozwarski","web":null}},{"frontmatter":{"author_id":"bartosz","avatar":"/images/members/bartosz_szafran.jpg","bio":"Senior Frontend Developer","name":"Bartosz Szafran","web":null}},{"frontmatter":{"author_id":"daniel","avatar":"/images/members/daniel_makurat.jpg","bio":"Co-founder & Senior Backend developer","name":"Daniel Makurat","web":null}},{"frontmatter":{"author_id":"eliasz","avatar":"/images/members/eliasz.png","bio":"Software Engineer @ Bright Inventions","name":"Eliasz Sawicki","web":"http://eluss.github.io/"}},{"frontmatter":{"author_id":"fjablonski","avatar":"/images/members/filip_jablonski.jpg","bio":"Senior iOS developer","name":"Filip Jabłoński","web":null}},{"frontmatter":{"author_id":"grzesiek","avatar":"/images/members/grzegorz_ciesla.jpg","bio":"Software Developer","name":"Grzegorz Cieśla","web":null}},{"frontmatter":{"author_id":"ivan","avatar":"/images/members/ivan.jpg","bio":"Fullstack developer","name":"Ivan Menshykov","web":null}},{"frontmatter":{"author_id":"janek","avatar":"/images/members/janhanc.jpg","bio":"Frontend developer","name":"Jan Hanc","web":null}},{"frontmatter":{"author_id":"kwysocki","avatar":"/images/members/kamil.png","bio":"Software Engineer @ Bright Inventions","name":"Kamil Wysocki","web":"https://wysockikamil.com"}},{"frontmatter":{"author_id":"karoln","avatar":"/images/members/karol_nadratowski.jpg","bio":null,"name":"Karol Nadratowski","web":null}},{"frontmatter":{"author_id":"karol r","avatar":"/images/members/karol_rinc.jpg","bio":"Backend developer","name":"Karol Rinc","web":null}},{"frontmatter":{"author_id":"kasia","avatar":"/images/members/kasia_lukasiewicz.jpg","bio":"Senior Project Manager","name":"Kasia Łukasiewicz","web":null}},{"frontmatter":{"author_id":"kasia g","avatar":"/images/members/katarzyna_galka.jpg","bio":"Project manager","name":"Katarzyna Gałka","web":null}},{"frontmatter":{"author_id":"krzysiek h","avatar":"/images/members/krzysztof_hinc.jpg","bio":"Web developer","name":"Krzysiek Hinc","web":null}},{"frontmatter":{"author_id":"krzysiek","avatar":"/images/members/krzysztof_kaczmarek.jpg","bio":"Senior iOS Developer","name":"Krzysztof Kaczmarek","web":null}},{"frontmatter":{"author_id":"maciej","avatar":"/images/members/maciej_seleman.jpg","bio":"QA Specialist","name":"Maciej Seleman","web":null}},{"frontmatter":{"author_id":"magda","avatar":"/images/members/magda_sadowska.jpg","bio":"Office & HR Assistant","name":"Magda Sadowska","web":null}},{"frontmatter":{"author_id":"maja","avatar":"/images/members/maja_puta.jpg","bio":"Junior QA Specialist","name":"Maja Puta","web":null}},{"frontmatter":{"author_id":"marcink","avatar":"/images/members/marcin_kwiatkowski.jpg","bio":null,"name":"Marcin Kwiatkowski","web":null}},{"frontmatter":{"author_id":"mateusz","avatar":"/images/members/mateusz_klimczak.jpg","bio":"Technical leader & Project manager","name":"Mateusz Klimczak","web":null}},{"frontmatter":{"author_id":"mateuszklimek","avatar":"/images/members/mateuszklimek.png","bio":"Software Engineer @ Bright Inventions","name":"Mateusz Klimek","web":null}},{"frontmatter":{"author_id":"michal k","avatar":"/images/members/michal_koszalka.jpg","bio":"Senior Backend developer","name":"Michał Koszałka","web":null}},{"frontmatter":{"author_id":"michał","avatar":"/images/members/michal_wrobel.jpg","bio":"Senior Backend Developer at Bright Inventions","name":"Michał Wróbel","web":null}},{"frontmatter":{"author_id":"michal","avatar":"/images/members/michał_łukasiewicz.jpg","bio":"Co-founder & Senior iOS developer","name":"Michał Łukasiewicz","web":null}},{"frontmatter":{"author_id":"monika","avatar":"/images/members/monika.jpg","bio":"Software Developer @ Bright Inventions","name":"Monika Niegrzybowska","web":null}},{"frontmatter":{"author_id":"nikodem","avatar":"/images/members/nikodem_kalinowski.jpg","bio":"Web developer","name":"Nikodem Kalinowski","web":null}},{"frontmatter":{"author_id":"patryk","avatar":"/images/members/patryk_huzarski.jpg","bio":"Software Developer @ Bright Inventions","name":"Patryk Huzarski","web":null}},{"frontmatter":{"author_id":"patryk sz","avatar":"/images/members/patryk_szlagowski.jpg","bio":"Senior Backend developer","name":"Patryk Szlagowski","web":null}},{"frontmatter":{"author_id":"paweł","avatar":"/images/members/paweł_gutkowski.jpg","bio":"Fullstack Developer at Bright Inventions ","name":"Paweł Gutkowski","web":null}},{"frontmatter":{"author_id":"pawel","avatar":"/images/members/paweł_papkiewicz.jpg","bio":"Fullstack developer","name":"Paweł Papkiewicz","web":null}},{"frontmatter":{"author_id":"piotr","avatar":"/images/members/piotr_mionskowski.jpg","bio":"TDD fan eager to learn new things","name":"Piotr Mionskowski","web":"https://miensol.pl"}},{"frontmatter":{"author_id":"piotr_l","avatar":"/images/members/piotrl.png","bio":"Android Developer @ Bright Inventions","name":"Piotr Łupiński","web":"http://exp.flamaster2.com"}},{"frontmatter":{"author_id":"radek","avatar":"/images/members/radek_pieczątkiewicz.jpg","bio":"Android developer","name":"Radek Pieczątkiewicz","web":null}},{"frontmatter":{"author_id":"radeks","avatar":"/images/members/radoslaw.jpg","bio":"Software Engineer @ Bright Inventions","name":"Radosław Słowiński","web":null}},{"frontmatter":{"author_id":"rafal h","avatar":"/images/members/rafal_hoffman.jpg","bio":"Fullstack developer","name":"Rafał Hofman","web":null}},{"frontmatter":{"author_id":"sebastian","avatar":"/images/members/sebastian_sobczak.jpg","bio":"Junior Account Manager at Bright Inventions ","name":"Sebastian Sobczak","web":null}},{"frontmatter":{"author_id":"szymek","avatar":"/images/members/szymon_miloch.jpg","bio":"Android & Web developer","name":"Szymon Miloch","web":null}},{"frontmatter":{"author_id":"tomek","avatar":"/images/members/tomek.jpeg","bio":null,"name":"Tomasz Gęsior","web":null}},{"frontmatter":{"author_id":"ula","avatar":"/images/members/ula_stankiewicz.jpg","bio":"HR & Marketing Manager","name":"Ula Stankiewicz","web":null}},{"frontmatter":{"author_id":"wojciech","avatar":"/images/members/wojciech_baczyński.jpg","bio":"Fullstack developer","name":"Wojciech Baczyński","web":null}},{"frontmatter":{"author_id":"lukasz","avatar":"/images/members/lukasz_reszetow.jpg","bio":"Android developer","name":"Łukasz Reszetow","web":null}}]},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-02-08-microbenchmarking-on-android.md"}}}