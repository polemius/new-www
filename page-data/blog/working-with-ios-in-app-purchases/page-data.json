{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/working-with-ios-in-app-purchases","result":{"data":{"markdownRemark":{"html":"<p>There are more pleasant things to do in iOS development than setting up and testing in-app purchases. The process is laborious and requires thorough testing, especially that in-app purchases are crucial from a business perspective.</p>\n<h2>iTunes Connect configuration - part 1</h2>\n<p><strong>This tutorial is based on auto-renewable subscriptions, but you can configure any other in-app purchase in a very similar way.</strong></p>\n<p>To set up the in-app purchases follow the steps below:</p>\n<ol>\n<li>Log in to <a href=\"https://itunesconnect.apple.com\">iTunes Connect</a>.</li>\n<li>Open <strong>My Apps</strong> and select the app you'll configure.</li>\n<li>Open <strong>Features</strong> header and select <strong>In-App Purchases</strong> on the left pane.</li>\n<li>\n<p>Click <strong>+</strong> icon and select the in-app purchase type. There are 4 types of in-app purchases that you can use:</p>\n<p><img src=\"/images/working-with-ios-in-app-purchases/in-app-purchases.png\" alt=\"image\"></p>\n<p>Each type has a specific use case so make sure you read the descriptions first.</p>\n<p>If you can't see auto-renewable subscription you either haven't accepted updated <code>Apple Developer Program License Agreement</code> or you haven't completed filling Agreements, Tax, and Banking info on iTunes Connect.</p>\n</li>\n<li>\n<p><strong>Assuming you've selected Auto-Renewable Subscription</strong>, provide the <strong>Reference Name</strong> and <strong>Product ID</strong>.</p>\n<p>a) The reference name is used on iTunes Connect and in Sales and Trends reports only. It won't be displayed in the App Store, so it can be anything you like.</p>\n<p>b) Product ID must be unique, so it's recommended to use your app reversed domain with a subscription name, for example: <code>com.reversed.domain.onemonth</code>.</p>\n</li>\n<li>\n<p>Select <strong>Create New Subscription Group</strong> or choose an already existing group, if any.</p>\n<p>All auto-renewable subscriptions must be a part of a group. Users can only subscribe to one subscription in a group a time, but they can change to another subscription in the same group. This allows users to upgrade or downgrade a subscription without paying twice for the same service.</p>\n<p><strong>Subscription Group Reference Name</strong>, same as the reference name, is used on iTunes Connect and in Sales and Trends reports only.</p>\n</li>\n<li>\n<p>Auto-renewable subscription details page should appear. Select <strong>Subscription Duration</strong> (from 1 week to 1 year) and <strong>optional Free Trial</strong> period (from 3 days to 1 year).</p>\n<p><img src=\"/images/working-with-ios-in-app-purchases/subscription-duration.png\" alt=\"image\"></p>\n</li>\n<li>Click <strong>Set Starting Price</strong> to select the default currency and price (you must choose from pricing tiers), prices for other countries are calculated automatically.</li>\n<li>\n<p>Now you can select a different price for individual territories. After you save changes you'll notice that your price is kept as pricing tier:</p>\n<p><img src=\"/images/working-with-ios-in-app-purchases/pricing-tier.png\" alt=\"image\"></p>\n</li>\n<li>Add at least one <strong>Localization</strong> including <strong>Subscription Display Name</strong> and <strong>Description</strong>, preferably for all languages you support. Those values will be visible to the users, so make sure they sound trustworthy.</li>\n<li>Now you need to add at least one <strong>Localization</strong> to your subscription group. Save changes and select the group you've created in step 6 on the left pane. Fill <strong>Subscription Group Display Name</strong> and optionally set <strong>Custom Name</strong> if your app name is different than your service or publication name. Keep in mind that those values will be visible to the users.</li>\n</ol>\n<p>As you've probably noticed, we've skipped the <strong>Review Information</strong> section on the product details page. To fill up this section we first need to make an App Store call from our application in order to complete the configuration phase.</p>\n<p>Remember to complete filling your Agreements, Tax, and Banking info on iTunes Connect. You can find it on iTunes Connect main page or in the dropdown on top left corner of the page.</p>\n<h2>Setting up a test account</h2>\n<p>In order to test in the in-app purchases you need to create a sandbox test account.</p>\n<ol>\n<li>Log in to <a href=\"https://itunesconnect.apple.com\">iTunes Connect</a>.</li>\n<li>Open <strong>Users and Roles</strong>.</li>\n<li>\n<p>Open <strong>Sandbox Testers</strong> header.</p>\n<p><img src=\"/images/working-with-ios-in-app-purchases/sandbox-user.png\" alt=\"image\"></p>\n</li>\n<li>\n<p>Click <strong>+</strong> icon and fill the test account details. Keep the credentials.</p>\n<p>You can use a fake email address for testing (an easy one), but <strong>Apple might send you an email to verify the test account</strong> and by using a fake account you won't be able to do that so you'll need to create another one because purchases from an unverified account will always fail.</p>\n</li>\n</ol>\n<h2>Project configuration</h2>\n<p>Now you need to make some changes to your <strong>Xcode project</strong>.</p>\n<ol>\n<li>Open the project settings (click on the root of your project's files tree).</li>\n<li>In <strong>General</strong> header, scroll down to <strong>Linked Frameworks and Libraries</strong>.</li>\n<li>\n<p>Click <strong>+</strong> icon, find <strong>StoreKit.framework</strong> and click <strong>Add</strong>.</p>\n<p><img src=\"/images/working-with-ios-in-app-purchases/store-kit.png\" alt=\"image\"></p>\n</li>\n<li>\n<p>Open <strong>Capabilities</strong> header and turn <strong>In-App Purchase</strong> on.</p>\n<p><img src=\"/images/working-with-ios-in-app-purchases/capability.png\" alt=\"image\"></p>\n</li>\n</ol>\n<p>And it's finally time for some coding!</p>\n<h2>Code</h2>\n<p>First, you need to import the <code>StoreKit</code> in your class:</p>\n<pre><code class=\"language-swift\">import StoreKit\n</code></pre>\n<p>Before making any other action you should check whether user can make payments. If he can't, parental control might be turned on.</p>\n<pre><code class=\"language-swift\">SKPaymentQueue.canMakePayments()\n</code></pre>\n<p>In order to make purchases you need to download purchasable products first:</p>\n<pre><code class=\"language-swift\">private let kOneMonthSubscriptionId = \"com.reversed.domain.onemonth\"\n\nfunc loadProducts() {\n    let identifiers = Set([kOneMonthSubscriptionId])\n    let request = SKProductsRequest(productIdentifiers: identifiers)\n    request.delegate = self\n    request.start()\n}\n</code></pre>\n<p>Loaded products will be available in <code>productsRequest</code> method of <code>SKProductsRequestDelegate</code> delegate. To handle the store delegate methods your class needs to implement <code>SKProductsRequestDelegate</code>. You can wrap this up in an extension:</p>\n<pre><code class=\"language-swift\">extension SubscriptionService: SKProductsRequestDelegate {\n\n  func productsRequest(_ request: SKProductsRequest, didReceive response: SKProductsResponse) {\n    if response.products.count > 0 {\n      print(\"Purchasable products available!\")\n      // 1. Save the SKProduct's so you could let user make a purchase\n      // 2. Update the UI - it lets you change the product prices without updating the app\n    } else {\n      print(\"No purchasable products available.\")\n      // This might happen when your product identifiers are incorrect or your in-app purchases products weren't processed on iTunes Connect yet\n    }\n  }\n\n}\n</code></pre>\n<p>If you aren't able to fetch the purchasable products you've configured, please note that <strong>it can take even up to few hours</strong> for your products to be registered on iTunes Connect.</p>\n<p>Now you can let users make a purchase. Remember to lock the UI with a loader until the process is finished to avoid double calls and to make sure that users know that something is going on.</p>\n<pre><code class=\"language-swift\">func purchase(product : SKProduct) {\n    let payment = SKPayment(product: product)\n    SKPaymentQueue.defaultQueue().addTransactionObserver(self)\n    SKPaymentQueue.defaultQueue().addPayment(payment)\n}\n</code></pre>\n<p>The result of the transaction is handled in <code>paymentQueue</code> method of <code>SKProductsRequestDelegate</code> delegate. Let's grow our extension:</p>\n<pre><code class=\"language-swift\">extension SubscriptionService: SKProductsRequestDelegate {\n  // (...)\n\n  func paymentQueue(queue: SKPaymentQueue, updatedTransactions transactions: [SKPaymentTransaction]) {\n        for transaction in transactions {\n            switch transaction.transactionState {\n            case .Purchasing:\n                print(\"The payment is being processed.\")\n            case .Purchased:\n                print(\"Payment processed successfully.\")\n                // Add your logic\n            case .Restored:\n                print(\"Payment restored successfully.\")\n                // Add your logic - it'll happen when your products could be restored (e.g. non-consumable products)\n            case .Failed:\n                if transaction.error?.code == SKErrorPaymentCancelled {\n                    print(\"User cancelled the payment.\")\n                    break;\n                }\n                print(\"Payment failed with error: \\(transaction.error ?? \"\")\")\n                // Handle the error\n            case .Deferred:\n                print(\"Payment is waiting for outside action.\")\n            }\n        }\n    }\n\n}\n</code></pre>\n<p>Remember to restore purchasable products that can be restored before letting users to make a purchase call because they won't be able to buy it again anyway.</p>\n<h2>Testing</h2>\n<p>To complete the configuration process you need to make sure that your payments are working and take a screenshot for the App Store review process. This is both easy and tricky so let's follow the steps below:</p>\n<ol>\n<li>\n<p>Sign out of you current Apple ID:</p>\n<p>a) Open your iPhone's <strong>Settings</strong>.</p>\n<p>b) Go to <strong>iTunes &#x26; App Stores</strong>.</p>\n<p>c) Select your email address and select <strong>Sign Out</strong>.</p>\n<p>Do not sign in using a sandbox account - you won't be able to do that.</p>\n</li>\n<li>Run your app and trigger an in-app purchase.</li>\n<li>You'll be prompted to provide an Apple ID. Use the <strong>sandbox account</strong> credentials and continue.</li>\n<li>The payment info dialog will be presented. Take a screenshot of your screen (hold power/sleep and home buttons simultaneously).</li>\n</ol>\n<p><img src=\"/images/working-with-ios-in-app-purchases/purchase-test.jpg\" alt=\"image\"></p>\n<p><strong>You must test the in-app purchases on a real device. Purchases will always fail on iOS simulator.</strong></p>\n<h2>iTunes Connect configuration - part 2</h2>\n<p>Since you have already implemented the in-app purchases and taken a screenshot of a system dialog while connecting to the App Store API, you can finally finish the iTunes Connect configuration.</p>\n<p>Go back to your in-app purchase details page on <strong>iTunes Connect</strong> (My Apps->Your app->Features->In-App Purchases->Your purchase) and scroll down to <strong>Review Information</strong>.</p>\n<p>Upload the screenshot and enter the credentials of the sandbox account you've used in <strong>Review Notes</strong>.</p>\n<p><img src=\"/images/working-with-ios-in-app-purchases/review-information.png\" alt=\"image\"></p>\n<p>Save changes and make sure that the <strong>Availability</strong> of your in-app purchase is set to <strong>Cleared for Sale</strong> (on the top of the page).</p>\n<p><img src=\"/images/working-with-ios-in-app-purchases/cleared-for-sale.png\" alt=\"image\"></p>\n<p>Keep in mind that your <strong>first in-app purchase must be submitted with a new app version</strong>. Once your binary has been uploaded and your first in-app purchase has been submitted for a review, additional in-app purchases can be submitted from the In-App Purchases section.</p>\n<h2>Server-side subscription validation</h2>\n<p>You can verify whether user's subscription is still valid outside the app. It's especially useful when your application is also available on other platforms with separate store like Android, and you decide to make your user pay only once per account, not per platform.</p>\n<p>To validate the user's subscription server-side you'll need a <strong>Shared Secret</strong>. You can find it in your app's In-App Purchases list (My Apps->Your app->Features->In-App Purchases), click <strong>App-Specific Shared Secret</strong> to open a dialog with the secret. If necessary, click <strong>Generate Shared Secret</strong>.</p>\n<p><img src=\"/images/working-with-ios-in-app-purchases/shared-secret.png\" alt=\"image\"></p>\n<p>Shared Secret, together with receipt details that you'll receive after completing the in-app purchase, will allow backend application to verify whether user's subscription is still valid or not.</p>\n<h2>Be meticulous</h2>\n<p>As you have probably noticed, <strong>setting up in-app purchases is arduous</strong>. Yet it's worth investing time in a meticulous step-by-step configuration to avoid unnecessary unpleasantness during the process.</p>\n<p>By the way, do you know, that even if you follow these instructions, <strong>your iOS app might be rejected?</strong> <a href=\"https://brightinventions.pl/blog/dont-let-your-ios-app-be-rejected/\">Check out this blog post to find out why</a>.</p>","excerpt":"There are more pleasant things to do in iOS development than setting up and testing in-app purchases. The process is laborious and requires…","frontmatter":{"slug":null,"title":"Working with iOS in-app purchases","description":null,"author":"mateusz","tags":["ios","in-app purchases","itunes connect","subscriptions","swift"],"date":"2017-10-30T23:00:00.000Z","image":null},"timeToRead":8,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2017-10-31-working-with-ios-in-app-purchases.md"},"allMarkdownRemark":{"nodes":[{"frontmatter":{"author_id":"adam","avatar":"/images/members/adam_bar.jpg","bio":"The Web Guy @ Bright Inventions","name":"Adam Bar","web":"https://whatwebcando.today"}},{"frontmatter":{"author_id":"agnieszka_h","avatar":"/images/members/agnieszka_h.jpg","bio":"Sales Manager @ Bright Inventions","name":"Agnieszka Hayashida","web":null}},{"frontmatter":{"author_id":"agnieszka","avatar":"/images/members/agnieszka_olszewska.jpg","bio":"Fullstack developer","name":"Agnieszka Olszewska","web":null}},{"frontmatter":{"author_id":"olo","avatar":"/images/members/aleksander_wielgorski.jpeg","bio":"Software Engineer @ Bright Inventions","name":"Aleksander Wielgórski","web":null}},{"frontmatter":{"author_id":"alisa","avatar":"/images/members/alisa_kashytska.jpg","bio":"Product designer","name":"Alisa Kashytska","web":null}},{"frontmatter":{"author_id":"azabost","avatar":"/images/members/andrzej_zabost.jpg","bio":"Senior Android developer","name":"Andrzej Zabost","web":"https://azabost.com"}},{"frontmatter":{"author_id":"arturs","avatar":"/images/members/artur.jpg","bio":"iOS developer","name":"Artur Suliński","web":null}},{"frontmatter":{"author_id":"bartek k","avatar":"/images/members/bartek_krzyzanski.jpg","bio":"Backend developer","name":"Bartek Krzyżański","web":null}},{"frontmatter":{"author_id":"bartekr","avatar":"/images/members/bartek.jpg","bio":"iOS developer","name":"Bartek Rozwarski","web":null}},{"frontmatter":{"author_id":"bartosz","avatar":"/images/members/bartosz_szafran.jpg","bio":"Senior Frontend Developer","name":"Bartosz Szafran","web":null}},{"frontmatter":{"author_id":"daniel","avatar":"/images/members/daniel_makurat.jpg","bio":"Co-founder & Senior Backend developer","name":"Daniel Makurat","web":null}},{"frontmatter":{"author_id":"eliasz","avatar":"/images/members/eliasz.png","bio":"Software Engineer @ Bright Inventions","name":"Eliasz Sawicki","web":"http://eluss.github.io/"}},{"frontmatter":{"author_id":"fjablonski","avatar":"/images/members/filip_jablonski.jpg","bio":"Senior iOS developer","name":"Filip Jabłoński","web":null}},{"frontmatter":{"author_id":"grzesiek","avatar":"/images/members/grzegorz_ciesla.jpg","bio":"Software Developer","name":"Grzegorz Cieśla","web":null}},{"frontmatter":{"author_id":"ivan","avatar":"/images/members/ivan.jpg","bio":"Fullstack developer","name":"Ivan Menshykov","web":null}},{"frontmatter":{"author_id":"janek","avatar":"/images/members/janhanc.jpg","bio":"Frontend developer","name":"Jan Hanc","web":null}},{"frontmatter":{"author_id":"kwysocki","avatar":"/images/members/kamil.png","bio":"Software Engineer @ Bright Inventions","name":"Kamil Wysocki","web":"https://wysockikamil.com"}},{"frontmatter":{"author_id":"karoln","avatar":"/images/members/karol_nadratowski.jpg","bio":null,"name":"Karol Nadratowski","web":null}},{"frontmatter":{"author_id":"karol r","avatar":"/images/members/karol_rinc.jpg","bio":"Backend developer","name":"Karol Rinc","web":null}},{"frontmatter":{"author_id":"kasia","avatar":"/images/members/kasia_lukasiewicz.jpg","bio":"Senior Project Manager","name":"Kasia Łukasiewicz","web":null}},{"frontmatter":{"author_id":"kasia g","avatar":"/images/members/katarzyna_galka.jpg","bio":"Project manager","name":"Katarzyna Gałka","web":null}},{"frontmatter":{"author_id":"krzysiek h","avatar":"/images/members/krzysztof_hinc.jpg","bio":"Web developer","name":"Krzysiek Hinc","web":null}},{"frontmatter":{"author_id":"krzysiek","avatar":"/images/members/krzysztof_kaczmarek.jpg","bio":"Senior iOS Developer","name":"Krzysztof Kaczmarek","web":null}},{"frontmatter":{"author_id":"maciej","avatar":"/images/members/maciej_seleman.jpg","bio":"QA Specialist","name":"Maciej Seleman","web":null}},{"frontmatter":{"author_id":"magda","avatar":"/images/members/magda_sadowska.jpg","bio":"Office & HR Assistant","name":"Magda Sadowska","web":null}},{"frontmatter":{"author_id":"maja","avatar":"/images/members/maja_puta.jpg","bio":"Junior QA Specialist","name":"Maja Puta","web":null}},{"frontmatter":{"author_id":"marcink","avatar":"/images/members/marcin_kwiatkowski.jpg","bio":null,"name":"Marcin Kwiatkowski","web":null}},{"frontmatter":{"author_id":"mateusz","avatar":"/images/members/mateusz_klimczak.jpg","bio":"Technical leader & Project manager","name":"Mateusz Klimczak","web":null}},{"frontmatter":{"author_id":"mateuszklimek","avatar":"/images/members/mateuszklimek.png","bio":"Software Engineer @ Bright Inventions","name":"Mateusz Klimek","web":null}},{"frontmatter":{"author_id":"michal k","avatar":"/images/members/michal_koszalka.jpg","bio":"Senior Backend developer","name":"Michał Koszałka","web":null}},{"frontmatter":{"author_id":"michał","avatar":"/images/members/michal_wrobel.jpg","bio":"Senior Backend Developer at Bright Inventions","name":"Michał Wróbel","web":null}},{"frontmatter":{"author_id":"michal","avatar":"/images/members/michał_łukasiewicz.jpg","bio":"Co-founder & Senior iOS developer","name":"Michał Łukasiewicz","web":null}},{"frontmatter":{"author_id":"monika","avatar":"/images/members/monika.jpg","bio":"Software Developer @ Bright Inventions","name":"Monika Niegrzybowska","web":null}},{"frontmatter":{"author_id":"nikodem","avatar":"/images/members/nikodem_kalinowski.jpg","bio":"Web developer","name":"Nikodem Kalinowski","web":null}},{"frontmatter":{"author_id":"patryk","avatar":"/images/members/patryk_huzarski.jpg","bio":"Software Developer @ Bright Inventions","name":"Patryk Huzarski","web":null}},{"frontmatter":{"author_id":"patryk sz","avatar":"/images/members/patryk_szlagowski.jpg","bio":"Senior Backend developer","name":"Patryk Szlagowski","web":null}},{"frontmatter":{"author_id":"paweł","avatar":"/images/members/paweł_gutkowski.jpg","bio":"Fullstack Developer at Bright Inventions ","name":"Paweł Gutkowski","web":null}},{"frontmatter":{"author_id":"pawel","avatar":"/images/members/paweł_papkiewicz.jpg","bio":"Fullstack developer","name":"Paweł Papkiewicz","web":null}},{"frontmatter":{"author_id":"piotr","avatar":"/images/members/piotr_mionskowski.jpg","bio":"TDD fan eager to learn new things","name":"Piotr Mionskowski","web":"https://miensol.pl"}},{"frontmatter":{"author_id":"piotr_l","avatar":"/images/members/piotrl.png","bio":"Android Developer @ Bright Inventions","name":"Piotr Łupiński","web":"http://exp.flamaster2.com"}},{"frontmatter":{"author_id":"radek","avatar":"/images/members/radek_pieczątkiewicz.jpg","bio":"Android developer","name":"Radek Pieczątkiewicz","web":null}},{"frontmatter":{"author_id":"radeks","avatar":"/images/members/radoslaw.jpg","bio":"Software Engineer @ Bright Inventions","name":"Radosław Słowiński","web":null}},{"frontmatter":{"author_id":"rafal h","avatar":"/images/members/rafal_hoffman.jpg","bio":"Fullstack developer","name":"Rafał Hofman","web":null}},{"frontmatter":{"author_id":"sebastian","avatar":"/images/members/sebastian_sobczak.jpg","bio":"Junior Account Manager at Bright Inventions ","name":"Sebastian Sobczak","web":null}},{"frontmatter":{"author_id":"szymek","avatar":"/images/members/szymon_miloch.jpg","bio":"Android & Web developer","name":"Szymon Miloch","web":null}},{"frontmatter":{"author_id":"tomek","avatar":"/images/members/tomek.jpeg","bio":null,"name":"Tomasz Gęsior","web":null}},{"frontmatter":{"author_id":"ula","avatar":"/images/members/ula_stankiewicz.jpg","bio":"HR & Marketing Manager","name":"Ula Stankiewicz","web":null}},{"frontmatter":{"author_id":"wojciech","avatar":"/images/members/wojciech_baczyński.jpg","bio":"Fullstack developer","name":"Wojciech Baczyński","web":null}},{"frontmatter":{"author_id":"lukasz","avatar":"/images/members/lukasz_reszetow.jpg","bio":"Android developer","name":"Łukasz Reszetow","web":null}}]},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2017-10-31-working-with-ios-in-app-purchases.md"}}}