{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/image-classification-tensorflowlite-android","result":{"data":{"markdownRemark":{"html":"<p>As I've already listed in my recent <a href=\"https://brightinventions.pl/blog/are-we-ready-for-deep-learning-on-mobile-devices/\">blog post</a> there are lots of advantages of making inference directly on a mobile device instead of using cloud solutions. Because of mobile devices' computation limitations, we can't migrate all of the available models to work on mobile. Unfortunately, plenty of them won't work on mobile devices but that's fine because we often don't need these heavy models on mobile devices. In this blog post, we will create a simple Android application that will take advantage of <a href=\"https://arxiv.org/abs/1801.04381\">MobileNetV2</a> that was pre-trained on ImageNet.</p>\n<p><img src=\"/images/image-classification-tensorflowlite-android/surf1.jpg\"></p>\n<h2>Let's make our hands dirty...</h2>\n<p>In our Android app project we need to add TFLite dependency to <code>build.gradle</code> file. </p>\n<pre><code>implementation 'org.tensorflow:tensorflow-lite:1.13.1'\n</code></pre>\n<p>and the undermentioned snippet to prevent compressing the model.</p>\n<pre><code>aaptOptions {  \n    noCompress \"tflite\"  \n    noCompress \"lite\"  \n}\n</code></pre>\n<p>The next step is to get a model for the image classification problem. One way is to create your own or take pre-trained one from <a href=\"https://www.tensorflow.org/lite/guide/hosted_models\">here</a> and put it to the <code>assets</code> folder. We will be using customized pre-trained MobileNetV2 that I've created for the sake of this demo. Our model will be able to or at least it should distinguish üåä <em>kitesurfing, windsurfing</em>, and <em>surfing</em> üèÑ‚Äç‚ôÇÔ∏è.  You can download this model as well as labels from my <a href=\"https://github.com/ares97/tflitedemo-mobilenetv2-imagenet-classification/tree/master/app/src/main/assets\">git repository</a>.</p>\n<p><img src=\"/images/image-classification-tensorflowlite-android/kite.jpg\"></p>\n<h3>Dive into the code</h3>\n<p>In order to make use of the prepared model we need to somehow import it into code. Let's use <code>tf.lite.Interpreter</code>   interface for the model. </p>\n<p>You can set up an interpreter in many ways, one recommended on <a href=\"https://www.tensorflow.org/lite/models/image_classification/android\">TF website</a> is to make use of <code>MappedByteBuffer</code>.</p>\n<pre><code class=\"language-kotlin\">@Throws(IOException::class)  \nprivate fun getModelByteBuffer(assetManager: AssetManager, modelPath: String): MappedByteBuffer {  \n    val fileDescriptor = assetManager.openFd(modelPath)  \n    val inputStream = FileInputStream(fileDescriptor.fileDescriptor)  \n    val fileChannel = inputStream.channel  \n    val startOffset = fileDescriptor.startOffset  \n    val declaredLength = fileDescriptor.declaredLength  \n    return fileChannel.map(FileChannel.MapMode.READ_ONLY, startOffset, declaredLength) \n}\n</code></pre>\n<p>and then...</p>\n<pre><code class=\"language-kotlin\">model = Interpreter(loadModelFile(activity))\n</code></pre>\n<p>Unfortunately using <code>MappedByteBuffer</code> as an argument is already deprecated and will be deleted in future releases but you can solve this problem by delivering ByteBuffer instead and it is as simple as invoking <code>.asReadOnlyBuffer()</code> on <code>loadModelFile</code> method.</p>\n<p>Next step is to read the file with labels. You can easily grab them with:</p>\n<pre><code class=\"language-kotlin\">@Throws(IOException::class)  \nprivate fun getLabels(assetManager: AssetManager, labelPath: String): List&#x3C;String> {  \n    val labels = ArrayList&#x3C;String>()  \n    val reader = BufferedReader(InputStreamReader(assetManager.open(labelPath)))  \n    while (true) {\n        val label = reader.readLine() ?: break\n        labels.add(label)\n    }  \n    reader.close()  \n    return labels  \n}\n</code></pre>\n<p>The last thing is to create a method that will take an image as an argument and return a list of labels with assigned probabilities to them.</p>\n<pre><code class=\"language-kotlin\">fun recognize(bitmap: Bitmap): List&#x3C;Recognition>{\n</code></pre>\n<p>Because our model expects the exact input shape (224x224 pixels) we need to rescale a delivered bitmap to fit into these constraints. </p>\n<pre><code class=\"language-kotlin\">    val scaledBitmap =  Bitmap.createScaledBitmap(bitmap, MODEL_INPUT_SIZE, MODEL_INPUT_SIZE, false)\n</code></pre>\n<p>Next, we need to create byteBuffer of appropriate size that will be passed as an argument to the model.</p>\n<pre><code class=\"language-kotlin\">    val byteBuffer = ByteBuffer  \n        .allocateDirect(  \n                    BATCH_SIZE *         // amount of images per single processing\n                    MODEL_INPUT_SIZE *   // img height\n                    MODEL_INPUT_SIZE *   // img width\n                    BYTES_PER_CHANNEL *  // size of float = 4\n                    PIXEL_SIZE           // r+g+b = 1+1+1\n      )  \n        .apply { order(ByteOrder.nativeOrder()) } // force device's native order (BIG_ENDIAN or LITTLE_ENDIAN)\n</code></pre>\n<p>And load <code>byteByffer</code> with the image data as <em>floating point numbers</em>. In order to decode color (ignoring alpha) in each pixel on a bitmap, we need to mask the least significant 8 bits and its multiple.</p>\n<pre><code class=\"language-kotlin\">    val pixelValues = IntArray(MODEL_INPUT_SIZE * MODEL_INPUT_SIZE)  \n    bitmap.getPixels(pixelValues, 0, bitmap.width, 0, 0, bitmap.width, bitmap.height)  \n  \n    var pixel = 0  \n    for (i in 0 until MODEL_INPUT_SIZE) {  \n        for (j in 0 until MODEL_INPUT_SIZE) {  \n            val pixelValue = pixelValues[pixel++]  \n            byteBuffer.putFloat((pixelValue shr 16 and 0xFF) / 255f)  \n            byteBuffer.putFloat((pixelValue shr 8 and 0xFF) / 255f)  \n            byteBuffer.putFloat((pixelValue and 0xFF) / 255f)  \n        }  \n    }\n</code></pre>\n<p>Finally, we can pass <em>byteBuffer</em> to the model. The interpreter expects for the second argument container for results and it is <em>array</em> of <em>float arrays</em> (<em>array</em> for each image and each one will contain <em>float array</em> of probabilities).</p>\n<pre><code class=\"language-kotlin\">    val results = Array(BATCH_SIZE) { FloatArray(labels.size) }\n    model.run(byteBuffer, results)\n    return parseResults(results)\n}\n</code></pre>\n<p>The last step is to bond probability with a proper class.</p>\n<pre><code class=\"language-kotlin\">private fun parseResults(result: Array&#x3C;FloatArray>): List&#x3C;Recognition> {  \n  \n    val recognitions = mutableListOf&#x3C;Recognition>()  \n  \n    labels.forEachIndexed { index, label ->  \n        val probability = result[0][index]  \n        recognitions.add(Recognition(label, probability))  \n    }  \n  \n  return recognitions.sortedByDescending { it.probability }  \n}\n</code></pre>\n<p>where <em>Recognition</em> is our humble result data class.</p>\n<pre><code class=\"language-kotlin\">data class Recognition(  \n    val name: String,  \n    val probability: Float  \n) {  \n    override fun toString() =  \n        \"$name : ${probability*100}%\"  \n}\n</code></pre>\n<h6>Don't forget that there are many things you should consider to make it work well i.e. handling a camera orientation or using post-training quantization if you need higher speed with a bit lower accuracy and lighter.</h6>\n<h2>It‚Äôs showtime!</h2>\n<p>The above code is a minimalistic version for getting TFLite solving for us <em>image classification</em> problem. With the provided model you can successfully classify all photos that are in this blog post. üì∏\nYou can find the demo <a href=\"https://github.com/ares97/tflitedemo-mobilenetv2-imagenet-classification\">here</a>.</p>\n<p><img src=\"/images/image-classification-tensorflowlite-android/windsurf.jpg\"></p>","excerpt":"As I've already listed in my recent blog post there are lots of advantages of making inference directly on a mobile device instead of using‚Ä¶","frontmatter":{"slug":null,"title":"Image classification with TensorFlow Lite on Android","description":null,"author":"radeks","tags":["android","tensorflow lite","deep learning","image classification"],"date":"2019-05-05T22:00:00.000Z","image":"/images/image-classification-tensorflowlite-android/surf1.jpg"},"timeToRead":4,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2019-05-06-image-classification-tensorflowlite-android.md"},"allMarkdownRemark":{"nodes":[{"frontmatter":{"author_id":"adam","avatar":"/images/members/adam_bar.jpg","bio":"The Web Guy @ Bright Inventions","name":"Adam Bar","web":"https://whatwebcando.today"}},{"frontmatter":{"author_id":"agnieszka_h","avatar":"/images/members/agnieszka_h.jpg","bio":"Sales Manager @ Bright Inventions","name":"Agnieszka Hayashida","web":null}},{"frontmatter":{"author_id":"agnieszka","avatar":"/images/members/agnieszka_olszewska.jpg","bio":"Fullstack developer","name":"Agnieszka Olszewska","web":null}},{"frontmatter":{"author_id":"olo","avatar":"/images/members/aleksander_wielgorski.jpeg","bio":"Software Engineer @ Bright Inventions","name":"Aleksander Wielg√≥rski","web":null}},{"frontmatter":{"author_id":"alisa","avatar":"/images/members/alisa_kashytska.jpg","bio":"Product designer","name":"Alisa Kashytska","web":null}},{"frontmatter":{"author_id":"azabost","avatar":"/images/members/andrzej_zabost.jpg","bio":"Senior Android developer","name":"Andrzej Zabost","web":"https://azabost.com"}},{"frontmatter":{"author_id":"arturs","avatar":"/images/members/artur.jpg","bio":"iOS developer","name":"Artur Suli≈Ñski","web":null}},{"frontmatter":{"author_id":"bartek k","avatar":"/images/members/bartek_krzyzanski.jpg","bio":"Backend developer","name":"Bartek Krzy≈ºa≈Ñski","web":null}},{"frontmatter":{"author_id":"bartekr","avatar":"/images/members/bartek.jpg","bio":"iOS developer","name":"Bartek Rozwarski","web":null}},{"frontmatter":{"author_id":"bartosz","avatar":"/images/members/bartosz_szafran.jpg","bio":"Senior Frontend Developer","name":"Bartosz Szafran","web":null}},{"frontmatter":{"author_id":"daniel","avatar":"/images/members/daniel_makurat.jpg","bio":"Co-founder & Senior Backend developer","name":"Daniel Makurat","web":null}},{"frontmatter":{"author_id":"eliasz","avatar":"/images/members/eliasz.png","bio":"Software Engineer @ Bright Inventions","name":"Eliasz Sawicki","web":"http://eluss.github.io/"}},{"frontmatter":{"author_id":"fjablonski","avatar":"/images/members/filip_jablonski.jpg","bio":"Senior iOS developer","name":"Filip Jab≈Ço≈Ñski","web":null}},{"frontmatter":{"author_id":"grzesiek","avatar":"/images/members/grzegorz_ciesla.jpg","bio":"Software Developer","name":"Grzegorz Cie≈õla","web":null}},{"frontmatter":{"author_id":"ivan","avatar":"/images/members/ivan.jpg","bio":"Fullstack developer","name":"Ivan Menshykov","web":null}},{"frontmatter":{"author_id":"janek","avatar":"/images/members/janhanc.jpg","bio":"Frontend developer","name":"Jan Hanc","web":null}},{"frontmatter":{"author_id":"kwysocki","avatar":"/images/members/kamil.png","bio":"Software Engineer @ Bright Inventions","name":"Kamil Wysocki","web":"https://wysockikamil.com"}},{"frontmatter":{"author_id":"karoln","avatar":"/images/members/karol_nadratowski.jpg","bio":null,"name":"Karol Nadratowski","web":null}},{"frontmatter":{"author_id":"karol r","avatar":"/images/members/karol_rinc.jpg","bio":"Backend developer","name":"Karol Rinc","web":null}},{"frontmatter":{"author_id":"kasia","avatar":"/images/members/kasia_lukasiewicz.jpg","bio":"Senior Project Manager","name":"Kasia ≈Åukasiewicz","web":null}},{"frontmatter":{"author_id":"kasia g","avatar":"/images/members/katarzyna_galka.jpg","bio":"Project manager","name":"Katarzyna Ga≈Çka","web":null}},{"frontmatter":{"author_id":"krzysiek h","avatar":"/images/members/krzysztof_hinc.jpg","bio":"Web developer","name":"Krzysiek Hinc","web":null}},{"frontmatter":{"author_id":"krzysiek","avatar":"/images/members/krzysztof_kaczmarek.jpg","bio":"Senior iOS Developer","name":"Krzysztof Kaczmarek","web":null}},{"frontmatter":{"author_id":"maciej","avatar":"/images/members/maciej_seleman.jpg","bio":"QA Specialist","name":"Maciej Seleman","web":null}},{"frontmatter":{"author_id":"magda","avatar":"/images/members/magda_sadowska.jpg","bio":"Office & HR Assistant","name":"Magda Sadowska","web":null}},{"frontmatter":{"author_id":"maja","avatar":"/images/members/maja_puta.jpg","bio":"Junior QA Specialist","name":"Maja Puta","web":null}},{"frontmatter":{"author_id":"marcink","avatar":"/images/members/marcin_kwiatkowski.jpg","bio":null,"name":"Marcin Kwiatkowski","web":null}},{"frontmatter":{"author_id":"mateusz","avatar":"/images/members/mateusz_klimczak.jpg","bio":"Technical leader & Project manager","name":"Mateusz Klimczak","web":null}},{"frontmatter":{"author_id":"mateuszklimek","avatar":"/images/members/mateuszklimek.png","bio":"Software Engineer @ Bright Inventions","name":"Mateusz Klimek","web":null}},{"frontmatter":{"author_id":"michal k","avatar":"/images/members/michal_koszalka.jpg","bio":"Senior Backend developer","name":"Micha≈Ç Kosza≈Çka","web":null}},{"frontmatter":{"author_id":"micha≈Ç","avatar":"/images/members/michal_wrobel.jpg","bio":"Senior Backend Developer at Bright Inventions","name":"Micha≈Ç Wr√≥bel","web":null}},{"frontmatter":{"author_id":"michal","avatar":"/images/members/micha≈Ç_≈Çukasiewicz.jpg","bio":"Co-founder & Senior iOS developer","name":"Micha≈Ç ≈Åukasiewicz","web":null}},{"frontmatter":{"author_id":"monika","avatar":"/images/members/monika.jpg","bio":"Software Developer @ Bright Inventions","name":"Monika Niegrzybowska","web":null}},{"frontmatter":{"author_id":"nikodem","avatar":"/images/members/nikodem_kalinowski.jpg","bio":"Web developer","name":"Nikodem Kalinowski","web":null}},{"frontmatter":{"author_id":"patryk","avatar":"/images/members/patryk_huzarski.jpg","bio":"Software Developer @ Bright Inventions","name":"Patryk Huzarski","web":null}},{"frontmatter":{"author_id":"patryk sz","avatar":"/images/members/patryk_szlagowski.jpg","bio":"Senior Backend developer","name":"Patryk Szlagowski","web":null}},{"frontmatter":{"author_id":"pawe≈Ç","avatar":"/images/members/pawe≈Ç_gutkowski.jpg","bio":"Fullstack Developer at Bright Inventions ","name":"Pawe≈Ç Gutkowski","web":null}},{"frontmatter":{"author_id":"pawel","avatar":"/images/members/pawe≈Ç_papkiewicz.jpg","bio":"Fullstack developer","name":"Pawe≈Ç Papkiewicz","web":null}},{"frontmatter":{"author_id":"piotr","avatar":"/images/members/piotr_mionskowski.jpg","bio":"TDD fan eager to learn new things","name":"Piotr Mionskowski","web":"https://miensol.pl"}},{"frontmatter":{"author_id":"piotr_l","avatar":"/images/members/piotrl.png","bio":"Android Developer @ Bright Inventions","name":"Piotr ≈Åupi≈Ñski","web":"http://exp.flamaster2.com"}},{"frontmatter":{"author_id":"radek","avatar":"/images/members/radek_pieczaÃ®tkiewicz.jpg","bio":"Android developer","name":"Radek PieczƒÖtkiewicz","web":null}},{"frontmatter":{"author_id":"radeks","avatar":"/images/members/radoslaw.jpg","bio":"Software Engineer @ Bright Inventions","name":"Rados≈Çaw S≈Çowi≈Ñski","web":null}},{"frontmatter":{"author_id":"rafal h","avatar":"/images/members/rafal_hoffman.jpg","bio":"Fullstack developer","name":"Rafa≈Ç Hofman","web":null}},{"frontmatter":{"author_id":"sebastian","avatar":"/images/members/sebastian_sobczak.jpg","bio":"Junior Account Manager at Bright Inventions ","name":"Sebastian Sobczak","web":null}},{"frontmatter":{"author_id":"szymek","avatar":"/images/members/szymon_miloch.jpg","bio":"Android & Web developer","name":"Szymon Miloch","web":null}},{"frontmatter":{"author_id":"tomek","avatar":"/images/members/tomek.jpeg","bio":null,"name":"Tomasz Gƒôsior","web":null}},{"frontmatter":{"author_id":"ula","avatar":"/images/members/ula_stankiewicz.jpg","bio":"HR & Marketing Manager","name":"Ula Stankiewicz","web":null}},{"frontmatter":{"author_id":"wojciech","avatar":"/images/members/wojciech_baczynÃÅski.jpg","bio":"Fullstack developer","name":"Wojciech Baczy≈Ñski","web":null}},{"frontmatter":{"author_id":"lukasz","avatar":"/images/members/lukasz_reszetow.jpg","bio":"Android developer","name":"≈Åukasz Reszetow","web":null}}]},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2019-05-06-image-classification-tensorflowlite-android.md"}}}