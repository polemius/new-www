{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/deploy-lambda-with-cloudformation","result":{"data":{"markdownRemark":{"html":"<p>Serverless deployments are popular these days. With a minimal cost you can have your own code wait and respond to various events. AWS Lambda, Azure Functions are just 2 examples of serverless offering from the biggest cloud providers. For a long time I had thought about them only in the context of ad-hoc setups not suitable for a long term development. This was until I found out that you can, with a little effort, version and deploy the serverless API just as a traditional back-end. In this post I am going to show how to deploy AWS Lambda functions with the help of the tool <a href=\"https://adambar.pl/\">Adam</a> created at <a href=\"https://brightinventions.pl/\">Bright Inventions</a> called <a href=\"https://github.com/bright/cloudform\">cloudform</a>.</p>\n<p><img src=\"/images/lambda/lambda.png\" alt=\"Lambda function\"></p>\n<h2>Step 1: Define a template</h2>\n<p>Let's install the <a href=\"https://github.com/bright/cloudform\">cloudform</a> <code>npm i --save-dev cloudform</code> and define a minimal template:</p>\n<pre><code class=\"language-typescript\">import cloudform, { Lambda, IAM, Fn } from 'cloudform';\n\nconst LambdaExecutionRole = 'LambdaExecutionRole';\n\ncloudform({\n    Resources: {\n        HelloWorld: new Lambda.Function({\n            Code: {\n                ZipFile: \"exports.wrtiteToConsole = function (event, context, callback){ console.log('Hello'); callback(null); }\"\n            },\n            Handler: \"index.wrtiteToConsole\",\n            Role: Fn.GetAtt(LambdaExecutionRole, \"Arn\"),\n            Runtime: \"nodejs6.10\"\n        }),\n        [LambdaExecutionRole]: new IAM.Role({\n            AssumeRolePolicyDocument: {\n                Statement: [{\n                    Effect: \"Allow\",\n                    Principal: { Service: [\"lambda.amazonaws.com\"] },\n                    Action: [\"sts:AssumeRole\"]\n                }]\n            },\n            Path: \"/\",\n            ManagedPolicyArns: [\"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"]\n        })\n    }\n});\n</code></pre>\n<p>There are only 2 resources defined in the template.  <code>HelloWorld</code> is the AWS Lambda function definition. We have set the <code>Runtime</code> property to use <code>nodejs6.10</code> hence the <code>Code.ZipFile</code> contains a JavaScript code. Despite the name <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-lambda-function-code.html#cfn-lambda-function-code-zipfile\"><code>ZipFile</code></a> should contain application source code in plain text. Obviously the <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-lambda-function-code.html\"><code>ZipFile</code></a> may only be used for the most simple functions. The <code>S3Bucket</code> and <code>S3Key</code> properties can be used to deploy a more involved function implementation. The <code>Handler</code> defines which function from <code>Code</code> the Lambda runtime should invoke. In case of <code>ZipFile</code> the first part is always <code>index</code>. </p>\n<p>The <code>Role</code> is a required setting for every AWS Lambda function. It defines what entitlements the code invoked by the Lambda runtime has. In the above template we define a policy which can be assumed by <code>lambda.amazonaws.com</code> and references a pre-defined AWS managed policy <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/intro-permission-model.html\"><code>AWSLambdaBasicExecutionRole</code></a>. The <code>AWSLambdaBasicExecutionRole</code> makes it possible for the Lambda function logs to be pushed to Cloud Watch.</p>\n<h2>Step 2: Create the AWS Lambda function</h2>\n<p>Deploying our Lambda function using CloudFormation requires a single command:</p>\n<pre><code class=\"language-bash\">aws cloudformation create-stack \\\n    --capabilities CAPABILITY_IAM \\\n    --stack-name lambda-example \\\n    --template-body file://&#x3C;(node_modules/.bin/cloudform aws-template.ts)\n</code></pre>\n<p>The <code>--capabilities CAPABILITY_IAM</code> is required whenever the CloudFormation has to define Roles, Policies or related resources. The <code>--template-body file://&#x3C;(node_modules/.bin/cloudform aws-template.ts)</code> instructs CloudFormation to use a template defined in a file. The <code>&#x3C;(...)</code> is <a href=\"https://superuser.com/questions/1059781/what-exactly-is-in-bash-and-in-zsh\">bash and zsh way to pass an output of a command</a> to other program as if the output was a file. After waiting a bit for the invocation to complete we will see the following in the AWS Console:</p>\n<p><img src=\"/images/lambda/aws-console.png\" alt=\"AWS Lambda Screen\"></p>\n<p>It is possible to use the AWS Console editor to test and change the function. However, if we are to treat the serverless approach seriously we should not forget about the standard practices like versioning of our source code.</p>\n<h2>Step 3: Update and version AWS Lambda function</h2>\n<p>Since we have defined the AWS Lambda function using a cloudform template we can version it as any other code. The whole serverless infrastructure we use and configure is treated as a source code allowing for an easy replication of deployment environments, audit trail and change management. Let's see how we can use cloudform to add another function that will be called by the first one.</p>\n<pre><code class=\"language-typescript\">import cloudform, { Lambda, IAM, Fn } from 'cloudform';\nimport { FunctionProperties } from 'cloudform/types/lambda/function';\nimport { readFileSync } from 'fs';\n\nconst\n    LambdaExecutionRole = 'LambdaExecutionRole',\n    Alice = 'Alice',\n    Bob = 'Bob';\n\nfunction lambdaFunction(\n    functionCode: string,\n    options?: Partial&#x3C;FunctionProperties>) {\n    return new Lambda.Function({\n        Code: { ZipFile: functionCode },\n        Handler: \"index.main\",\n        Role: Fn.GetAtt(LambdaExecutionRole, \"Arn\"),\n        Runtime: \"nodejs6.10\",\n        ...options\n    });\n}\n\nexport default cloudform({\n    Resources: {\n        [Alice]: lambdaFunction(readFileSync('Alice.js', 'utf-8'), {\n            Environment: {\n                Variables: {\n                    BobFunction: Fn.GetAtt(Bob, \"Arn\")\n                }\n            }\n        }),\n        [Bob]: lambdaFunction(readFileSync('Bob.js', 'utf-8')),\n        ... // LambdaExecutionRole see below\n    }\n})\n</code></pre>\n<p>As you can see above, we've extracted a function <code>lambdaFunction</code> to simplify Lambda function declaration. Both <code>Alice</code> and <code>Bob</code> function's bodies are defined in separate files. Interestingly  <code>Alice</code> function, during the invocation, will have access to <code>BobFunction</code> environment variable pointing to <code>Bob</code> function <a href=\"https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html\">ARN</a>.</p>\n<p>Our <code>LambdaExecutionRole</code> lacks a permission to invoke another Lambda function. Let's fix that:</p>\n<pre><code class=\"language-typescript\">    [LambdaExecutionRole]: new IAM.Role({\n        AssumeRolePolicyDocument: {\n            Statement: [{\n                Effect: \"Allow\",\n                Principal: { Service: [\"lambda.amazonaws.com\"] },\n                Action: [\"sts:AssumeRole\"]\n            }]\n        },\n        Path: \"/\",\n        ManagedPolicyArns: [\"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"],\n        Policies: [{\n            PolicyName: \"AllowCallingOtherLambda\",\n            PolicyDocument: {\n                Version: \"2012-10-17\",\n                Statement: [{\n                    Sid: \"InvokeLambdaPermission\",\n                    Effect: \"Allow\",\n                    Action: [\"lambda:InvokeFunction\"],\n                    Resource: \"*\"\n                }]\n            }\n        }]\n    })\n</code></pre>\n<p>The <code>Alice</code> and <code>Bob</code> sources export <code>main</code> functions invoked by AWS Lambda runtime:</p>\n<pre><code class=\"language-typescript\">// Alice.ts\nimport aws from 'aws-sdk';\n\nexport function main(event: any, context: any, callback: Function) {\n    new aws.Lambda().invoke({\n        FunctionName: process.env.BobFunction!,\n        Payload: JSON.stringify({message: \"Hi!. I'm Alice.\"})\n    }, (error: Error, data: any) => {\n        const response = JSON.parse(data.Payload);\n        console.log('FromBob', error || response)\n        callback(error);\n    });\n}\n\n// Bob.ts\nexport function main(event: any, context: any, callback: any) {\n    console.log('FromAlice', event)\n    callback(null, {message: \"Hi! I'm Bob. Nice to meet you!\"});\n}\n</code></pre>\n<p>Since we now use TypeScript for <code>Alice</code> and <code>Bob</code> source we need to install the compiler <code>npm i --save-dev typescript @types/node aws-sdk</code>. Unfortunately currently in <a href=\"https://github.com/bright/cloudform\">cloudform</a> it is not possible to use custom <code>tsconfig.json</code> for the compilation. Fortunately we can invoke the compiler manually and use its outputs as any other Node.js source code. With a <code>tsconfig.json</code>:</p>\n<pre><code class=\"language-json\">{\n  \"compilerOptions\": {\n    \"module\": \"commonjs\",\n    \"target\": \"es6\",\n    \"strict\": true, \n    \"strictPropertyInitialization\": false,\n    \"esModuleInterop\": true\n  },\n  \"exclude\": [\"node_modules\"],\n  \"compileOnSave\": true\n}\n</code></pre>\n<p>we can use the following commands to compile and deploy Lambda functions:</p>\n<pre><code class=\"language-bash\">./node_modules/.bin/tsc\n\naws cloudformation update-stack \\\n    --capabilities CAPABILITY_IAM \\\n    --stack-name lambda-example \\\n    --template-body file://&#x3C;(node -e \"console.log((require('./aws-template').default))\")\n</code></pre>\n<p>After the stack update completes we now should have 2 Lambda functions available. When we invoke the <code>Alice</code> function, we'll see that the 2 AWS Lambda functions communicate:</p>\n<pre><code>START RequestId: 6a87c764-251e-11e8-b921-f9ca7649c7d7 Version: $LATEST\n2018-03-11T11:22:00.615Z    6a87c764-251e-11e8-b921-f9ca7649c7d7    Alice says: Hi!. I'm Alice.\n2018-03-11T11:22:01.676Z    6a87c764-251e-11e8-b921-f9ca7649c7d7    Bob says: Hi! I'm Bob. Nice to meet you!\nEND RequestId: 6a87c764-251e-11e8-b921-f9ca7649c7d7\nREPORT RequestId: 6a87c764-251e-11e8-b921-f9ca7649c7d7  Duration: 1110.68 ms    Billed Duration: 1200 ms    Memory Size: 128 MB Max Memory Used: 34 MB  \n</code></pre>\n<p>Serverless infrastructure offers endless possibilities. With <a href=\"https://github.com/bright/cloudform\">cloudform</a> we can take AWS Lambda development, change management and deployment to the next level.</p>","excerpt":"Serverless deployments are popular these days. With a minimal cost you can have your own code wait and respond to various events. AWS Lambda…","frontmatter":{"slug":null,"title":"How to deploy Lambda function with CloudFormation?","description":null,"author":"piotr","tags":["aws","cloudformation","lambda","cloudform"],"date":"2018-03-11T23:00:00.000Z","image":"/images/lambda/lambda.png"},"timeToRead":6,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-03-12-deploy-lambda-with-cloudformation.md"},"allMarkdownRemark":{"nodes":[{"frontmatter":{"author_id":"adam","avatar":"/images/members/adam_bar.jpg","bio":"The Web Guy @ Bright Inventions","name":"Adam Bar","web":"https://whatwebcando.today"}},{"frontmatter":{"author_id":"agnieszka_h","avatar":"/images/members/agnieszka_h.jpg","bio":"Sales Manager @ Bright Inventions","name":"Agnieszka Hayashida","web":null}},{"frontmatter":{"author_id":"agnieszka","avatar":"/images/members/agnieszka_olszewska.jpg","bio":"Fullstack developer","name":"Agnieszka Olszewska","web":null}},{"frontmatter":{"author_id":"olo","avatar":"/images/members/aleksander_wielgorski.jpeg","bio":"Software Engineer @ Bright Inventions","name":"Aleksander Wielgórski","web":null}},{"frontmatter":{"author_id":"alisa","avatar":"/images/members/alisa_kashytska.jpg","bio":"Product designer","name":"Alisa Kashytska","web":null}},{"frontmatter":{"author_id":"azabost","avatar":"/images/members/andrzej_zabost.jpg","bio":"Senior Android developer","name":"Andrzej Zabost","web":"https://azabost.com"}},{"frontmatter":{"author_id":"arturs","avatar":"/images/members/artur.jpg","bio":"iOS developer","name":"Artur Suliński","web":null}},{"frontmatter":{"author_id":"bartek k","avatar":"/images/members/bartek_krzyzanski.jpg","bio":"Backend developer","name":"Bartek Krzyżański","web":null}},{"frontmatter":{"author_id":"bartekr","avatar":"/images/members/bartek.jpg","bio":"iOS developer","name":"Bartek Rozwarski","web":null}},{"frontmatter":{"author_id":"bartosz","avatar":"/images/members/bartosz_szafran.jpg","bio":"Senior Frontend Developer","name":"Bartosz Szafran","web":null}},{"frontmatter":{"author_id":"daniel","avatar":"/images/members/daniel_makurat.jpg","bio":"Co-founder & Senior Backend developer","name":"Daniel Makurat","web":null}},{"frontmatter":{"author_id":"eliasz","avatar":"/images/members/eliasz.png","bio":"Software Engineer @ Bright Inventions","name":"Eliasz Sawicki","web":"http://eluss.github.io/"}},{"frontmatter":{"author_id":"fjablonski","avatar":"/images/members/filip_jablonski.jpg","bio":"Senior iOS developer","name":"Filip Jabłoński","web":null}},{"frontmatter":{"author_id":"grzesiek","avatar":"/images/members/grzegorz_ciesla.jpg","bio":"Software Developer","name":"Grzegorz Cieśla","web":null}},{"frontmatter":{"author_id":"ivan","avatar":"/images/members/ivan.jpg","bio":"Fullstack developer","name":"Ivan Menshykov","web":null}},{"frontmatter":{"author_id":"janek","avatar":"/images/members/janhanc.jpg","bio":"Frontend developer","name":"Jan Hanc","web":null}},{"frontmatter":{"author_id":"kwysocki","avatar":"/images/members/kamil.png","bio":"Software Engineer @ Bright Inventions","name":"Kamil Wysocki","web":"https://wysockikamil.com"}},{"frontmatter":{"author_id":"karoln","avatar":"/images/members/karol_nadratowski.jpg","bio":null,"name":"Karol Nadratowski","web":null}},{"frontmatter":{"author_id":"karol r","avatar":"/images/members/karol_rinc.jpg","bio":"Backend developer","name":"Karol Rinc","web":null}},{"frontmatter":{"author_id":"kasia","avatar":"/images/members/kasia_lukasiewicz.jpg","bio":"Senior Project Manager","name":"Kasia Łukasiewicz","web":null}},{"frontmatter":{"author_id":"kasia g","avatar":"/images/members/katarzyna_galka.jpg","bio":"Project manager","name":"Katarzyna Gałka","web":null}},{"frontmatter":{"author_id":"krzysiek h","avatar":"/images/members/krzysztof_hinc.jpg","bio":"Web developer","name":"Krzysiek Hinc","web":null}},{"frontmatter":{"author_id":"krzysiek","avatar":"/images/members/krzysztof_kaczmarek.jpg","bio":"Senior iOS Developer","name":"Krzysztof Kaczmarek","web":null}},{"frontmatter":{"author_id":"maciej","avatar":"/images/members/maciej_seleman.jpg","bio":"QA Specialist","name":"Maciej Seleman","web":null}},{"frontmatter":{"author_id":"magda","avatar":"/images/members/magda_sadowska.jpg","bio":"Office & HR Assistant","name":"Magda Sadowska","web":null}},{"frontmatter":{"author_id":"maja","avatar":"/images/members/maja_puta.jpg","bio":"Junior QA Specialist","name":"Maja Puta","web":null}},{"frontmatter":{"author_id":"marcink","avatar":"/images/members/marcin_kwiatkowski.jpg","bio":null,"name":"Marcin Kwiatkowski","web":null}},{"frontmatter":{"author_id":"mateusz","avatar":"/images/members/mateusz_klimczak.jpg","bio":"Technical leader & Project manager","name":"Mateusz Klimczak","web":null}},{"frontmatter":{"author_id":"mateuszklimek","avatar":"/images/members/mateuszklimek.png","bio":"Software Engineer @ Bright Inventions","name":"Mateusz Klimek","web":null}},{"frontmatter":{"author_id":"michal k","avatar":"/images/members/michal_koszalka.jpg","bio":"Senior Backend developer","name":"Michał Koszałka","web":null}},{"frontmatter":{"author_id":"michał","avatar":"/images/members/michal_wrobel.jpg","bio":"Senior Backend Developer at Bright Inventions","name":"Michał Wróbel","web":null}},{"frontmatter":{"author_id":"michal","avatar":"/images/members/michał_łukasiewicz.jpg","bio":"Co-founder & Senior iOS developer","name":"Michał Łukasiewicz","web":null}},{"frontmatter":{"author_id":"monika","avatar":"/images/members/monika.jpg","bio":"Software Developer @ Bright Inventions","name":"Monika Niegrzybowska","web":null}},{"frontmatter":{"author_id":"nikodem","avatar":"/images/members/nikodem_kalinowski.jpg","bio":"Web developer","name":"Nikodem Kalinowski","web":null}},{"frontmatter":{"author_id":"patryk","avatar":"/images/members/patryk_huzarski.jpg","bio":"Software Developer @ Bright Inventions","name":"Patryk Huzarski","web":null}},{"frontmatter":{"author_id":"patryk sz","avatar":"/images/members/patryk_szlagowski.jpg","bio":"Senior Backend developer","name":"Patryk Szlagowski","web":null}},{"frontmatter":{"author_id":"paweł","avatar":"/images/members/paweł_gutkowski.jpg","bio":"Fullstack Developer at Bright Inventions ","name":"Paweł Gutkowski","web":null}},{"frontmatter":{"author_id":"pawel","avatar":"/images/members/paweł_papkiewicz.jpg","bio":"Fullstack developer","name":"Paweł Papkiewicz","web":null}},{"frontmatter":{"author_id":"piotr","avatar":"/images/members/piotr_mionskowski.jpg","bio":"TDD fan eager to learn new things","name":"Piotr Mionskowski","web":"https://miensol.pl"}},{"frontmatter":{"author_id":"piotr_l","avatar":"/images/members/piotrl.png","bio":"Android Developer @ Bright Inventions","name":"Piotr Łupiński","web":"http://exp.flamaster2.com"}},{"frontmatter":{"author_id":"radek","avatar":"/images/members/radek_pieczątkiewicz.jpg","bio":"Android developer","name":"Radek Pieczątkiewicz","web":null}},{"frontmatter":{"author_id":"radeks","avatar":"/images/members/radoslaw.jpg","bio":"Software Engineer @ Bright Inventions","name":"Radosław Słowiński","web":null}},{"frontmatter":{"author_id":"rafal h","avatar":"/images/members/rafal_hoffman.jpg","bio":"Fullstack developer","name":"Rafał Hofman","web":null}},{"frontmatter":{"author_id":"sebastian","avatar":"/images/members/sebastian_sobczak.jpg","bio":"Junior Account Manager at Bright Inventions ","name":"Sebastian Sobczak","web":null}},{"frontmatter":{"author_id":"szymek","avatar":"/images/members/szymon_miloch.jpg","bio":"Android & Web developer","name":"Szymon Miloch","web":null}},{"frontmatter":{"author_id":"tomek","avatar":"/images/members/tomek.jpeg","bio":null,"name":"Tomasz Gęsior","web":null}},{"frontmatter":{"author_id":"ula","avatar":"/images/members/ula_stankiewicz.jpg","bio":"HR & Marketing Manager","name":"Ula Stankiewicz","web":null}},{"frontmatter":{"author_id":"wojciech","avatar":"/images/members/wojciech_baczyński.jpg","bio":"Fullstack developer","name":"Wojciech Baczyński","web":null}},{"frontmatter":{"author_id":"lukasz","avatar":"/images/members/lukasz_reszetow.jpg","bio":"Android developer","name":"Łukasz Reszetow","web":null}}]},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-03-12-deploy-lambda-with-cloudformation.md"}}}