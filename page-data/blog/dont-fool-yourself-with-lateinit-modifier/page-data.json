{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/dont-fool-yourself-with-lateinit-modifier","result":{"data":{"markdownRemark":{"html":"<p>Kotlin language provides a nice and clean way to handle nullable variables in code so that it is less error prone. Unless you do it all wrong, of course.</p>\n<h1>lateinit modifier</h1>\n<p>Normally, all non-nullable properties in Kotlin classes must be properly initialized. You can do it in several ways:</p>\n<ul>\n<li>in primary constructor,</li>\n<li>in initializer block(s),</li>\n<li>in the class body,</li>\n<li>with a getter*,</li>\n<li>with a delegate*.</li>\n</ul>\n<p><em>* Well, it's not an initialization per se, but it makes compiler aware that's not <code>null</code></em></p>\n<p>But if your property is lifecycle-driven (e.g. a reference to a button which gets inflated during Android Activity lifecycle) or it is initialized through injection, you cannot supply a non-null initializer and you must declare its type as nullable. This in turn will require you to use null checks every time you reference the property, which may be a bit inconvenient, especially if you are absolutely sure the property will get initialized at some point, before you access it for the first time.</p>\n<p>Kotlin has a simple solution for such a scenario, allowing you to mark the property with the <code>lateinit</code> modifier. Thanks to this you can have a non-nullable type so that you don't have to check if it's <code>null</code> while referencing it. Of course, if you access the property before initialization, you'll get an <code>UninitializedPropertyAccessException</code>.</p>\n<h1>Lateinits vs nullables</h1>\n<p>The described possibility, despite being a great feature, may also be tempting to overuse in places where the initialization is not so certain (e.g. conditional or just <em>too late</em>), making the code less null-aware, less predictable and more like Java, thus - naturally - you might be doubtful if certain usages are right or not. So here's my rule of thumb that I use when making decision if particular variable should be <code>lateinit</code> or just nullable. It's very subjective and it tends to change with time so feel free to share your own experiences in comments.</p>\n<h2>Lateinit #1: beginning of a lifecycle</h2>\n<p>You can intialize properties when your classes' lifecycle-beginning methods get invoked, e.g. <code>Activity.onCreate()</code>. It's a common case if you use a dependency injection framework like <a href=\"https://google.github.io/dagger/\">Dagger</a>.</p>\n<pre><code class=\"language-kotlin\">abstract class BaseActivity : AppCompatActivity() {\n    override fun onCreate(savedInstanceState: Bundle?) {\n        AndroidInjection.inject(this)\n        super.onCreate(savedInstanceState)\n    }\n}\n\nclass LoginActivity : BaseActivity() {\n\n    @Inject\n    lateinit var viewModelFactory: ViewModelProvider.Factory\n\n    lateinit var viewModel: LoginViewModel\n\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n\n        viewModel = ViewModelProviders.of(this, viewModelFactory).get(LoginViewModel::class.java)\n\n        setContentView(R.layout.login_activity)\n    }\n}\n</code></pre>\n<p>It's also very useful if you want to <code>getSystemService()</code>:</p>\n<pre><code class=\"language-kotlin\">class MainActivity : AppCompatActivity() {\n\n    lateinit var alarmManager: AlarmManager\n\n    // This wouldn't work:\n    // val alarmService = getSystemService(AlarmManager::class.java)\n\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        alarmManager = getSystemService(AlarmManager::class.java)\n}\n</code></pre>\n<p>Otherwise you would get an <code>IllegalStateException</code> saying that system services are not available to Activities before <code>onCreate()</code>.</p>\n<p>You can also avoid the <code>this</code> reference escape during object construction <a href=\"https://wiki.sei.cmu.edu/confluence/display/java/TSM01-J.+Do+not+let+the+this+reference+escape+during+object+construction\">for thread-safety</a>:</p>\n<pre><code class=\"language-kotlin\">class MyActivity : AppCompatActivity() {\n\n    lateinit var alien: Alien\n    // instead of:\n    // val alien = Alien(this)\n\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        alien = Alien(this)\n    }\n}\n</code></pre>\n<h2>Lateinit #2: fail-fast approach</h2>\n<p>You may prefer to write a code that is designed to fail as soon as possible and stop normal operation rather than attempt to continue a flawed process. An extreme case could be crashing the app so that you can detect failures early. It can be especially useful in situations where the code is straightforward and predictable.</p>\n<p>For example, let's imagine an Activity that uses <code>MediaPlayer</code> to play music. It might look like this:</p>\n<pre><code class=\"language-kotlin\">class PlayerActivity : AppCompatActivity() {\n\n    lateinit var mediaPlayer: MediaPlayer\n    lateinit var mediaUri: Uri\n\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        setContentView(R.layout.activity_player)\n        mediaUri = intent.getParcelableExtra(\"mediaUri\")\n    }\n\n    override fun onStart() {\n        super.onStart()\n        mediaPlayer = MediaPlayer()\n        mediaPlayer.setDataSource(this, mediaUri)\n        mediaPlayer.prepare()\n        mediaPlayer.start()\n    }\n\n    override fun onStop() {\n        super.onStop()\n        mediaPlayer.stop()\n        mediaPlayer.release()\n    }\n}\n</code></pre>\n<p>It's quite easy to spot a risky assignment in <code>onCreate</code> as retrieving <code>mediaUri</code> from the passed intent may end up with an exception if the intent did not contain it.</p>\n<p><code>java.lang.IllegalStateException: intent.getParcelableExtra(\"mediaUri\") must not be null</code></p>\n<p>On the other hand, the code is clear and simple and it's not too hard to test it. But if you feel your specific case needs a bit of explanation then I encourage you to document such design decision.</p>\n<p><img src=\"/images/dont-fool-yourself-with-lateinit-modifier/risk_inside.jpg\" alt=\"Risk inside\">{: .center-image}</p>\n<h2>Nullable #1: crash-free approach</h2>\n<p>There might be cases when you would like to avoid crashing the app at all cost, even if something is not going to work properly. It doesn't mean that using <code>lateinit</code> like in the previous \"fail-fast\" example must end up with a crash as you can catch the exceptions, but I think it's quite common to choose between these two extremes: either let the app crash and don't mind catching the exceptions or avoid crashing using nullable variables.</p>\n<p>Let's modify the previous example by replacing <code>lateinit</code>s with nullable types:</p>\n<pre><code class=\"language-kotlin\">class PlayerActivity : AppCompatActivity() {\n\n    var mediaPlayer: MediaPlayer? = null\n    var mediaUri: Uri? = null\n\n    override fun onCreate(savedInstanceState: Bundle?) {\n        super.onCreate(savedInstanceState)\n        setContentView(R.layout.activity_player)\n        mediaUri = intent.getParcelableExtra(\"mediaUri\")\n    }\n\n    override fun onStart() {\n        super.onStart()\n\n        mediaUri?.let {\n            val player = MediaPlayer()\n            player.setDataSource(this, it)\n            player.prepare()\n            player.start()\n            mediaPlayer = player\n        }\n    }\n\n    override fun onStop() {\n        super.onStop()\n        mediaPlayer?.stop()\n        mediaPlayer?.release()\n    }\n}\n</code></pre>\n<p>So this time, if we don't get any <code>mediaUri</code>, we just don't play the music. The app won't crash, but the user will be surprised by the silence (he might even wonder if his phone is broken). Is it better than crashing? That's your choice. But the good thing about this approach is that you have an opportunity to actually test the variable using a regular <code>if</code> statement and do something else if it wasn't initialized with a non-null value.</p>\n<p><em>Note: since Kotlin 1.2 you can use <code>.isInitialized</code> on a reference to a <code>lateinit</code> property, but it may render your code even more unreadable and it has some limitations (see <a href=\"https://kotlinlang.org/docs/reference/properties.html\">the docs</a>):</em></p>\n<blockquote>\n<p>This check is only available for the properties that are lexically accessible, i.e. declared in the same type or in one of the outer types, or at top level in the same file.</p>\n</blockquote>\n<h2>Nullable #2: very late initialization</h2>\n<p>I've seen a piece of code that was \"remembering\" a clicked list item data in a <code>lateinit</code> variable, starting another Activity with <code>startActivityForResult()</code> and finally, when it has finished and <code>onActivityResult()</code> was called, the \"remembered\" value was read and used (and I was quite surprised it hasn't been lost in the meantime).</p>\n<pre><code class=\"language-kotlin\">class SomeActivity : AppCompatActivity() {\n\n    lateinit var selectedItemData: ItemData\n\n    // a ton of code ...\n\n    private fun doSomethingWithItem(data: ItemData) {\n        // another ton of code ...\n\n        if (...) { // long and complex conditions\n            if (...) {\n                data?.anotherData?.let { // may not happen and won't let you know\n                    selectedItemData = data\n                    startActivityForResult(...)\n                }\n            }\n        }\n    }\n\n    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {\n        doSomethingElse(selectedItemData)\n    }\n}\n</code></pre>\n<p>Generally speaking, I avoid such constructions and I call them \"too late initialization\". In such cases I prefer to use a nullable type instead to make it clear the variable is <code>null</code> most of the time.</p>\n<h1>How not to fool yourself?</h1>\n<p>Make the property nullable if it makes better sense and improves null safety. <code>lateinit</code> might be good if used properly but it has its cons as well. Don't make it a replacement for <code>NullPointerException</code>.</p>","excerpt":"Kotlin language provides a nice and clean way to handle nullable variables in code so that it is less error prone. Unless you do it all…","frontmatter":{"slug":null,"title":"Don't fool yourself with lateinit modifier","description":null,"author":"azabost","tags":["android","kotlin"],"date":"2018-03-22T00:00:00.000Z","image":"/images/dont-fool-yourself-with-lateinit-modifier/risk_inside.jpg"},"timeToRead":6,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-03-02-dont-fool-yourself-with-lateinit-modifier.md"},"allMarkdownRemark":{"nodes":[{"frontmatter":{"author_id":"adam","avatar":"/images/members/adam_bar.jpg","bio":"The Web Guy @ Bright Inventions","name":"Adam Bar","web":"https://whatwebcando.today"}},{"frontmatter":{"author_id":"agnieszka_h","avatar":"/images/members/agnieszka_h.jpg","bio":"Sales Manager @ Bright Inventions","name":"Agnieszka Hayashida","web":null}},{"frontmatter":{"author_id":"agnieszka","avatar":"/images/members/agnieszka_olszewska.jpg","bio":"Fullstack developer","name":"Agnieszka Olszewska","web":null}},{"frontmatter":{"author_id":"olo","avatar":"/images/members/aleksander_wielgorski.jpeg","bio":"Software Engineer @ Bright Inventions","name":"Aleksander Wielgórski","web":null}},{"frontmatter":{"author_id":"alisa","avatar":"/images/members/alisa_kashytska.jpg","bio":"Product designer","name":"Alisa Kashytska","web":null}},{"frontmatter":{"author_id":"azabost","avatar":"/images/members/andrzej_zabost.jpg","bio":"Senior Android developer","name":"Andrzej Zabost","web":"https://azabost.com"}},{"frontmatter":{"author_id":"arturs","avatar":"/images/members/artur.jpg","bio":"iOS developer","name":"Artur Suliński","web":null}},{"frontmatter":{"author_id":"bartek k","avatar":"/images/members/bartek_krzyzanski.jpg","bio":"Backend developer","name":"Bartek Krzyżański","web":null}},{"frontmatter":{"author_id":"bartekr","avatar":"/images/members/bartek.jpg","bio":"iOS developer","name":"Bartek Rozwarski","web":null}},{"frontmatter":{"author_id":"bartosz","avatar":"/images/members/bartosz_szafran.jpg","bio":"Senior Frontend Developer","name":"Bartosz Szafran","web":null}},{"frontmatter":{"author_id":"daniel","avatar":"/images/members/daniel_makurat.jpg","bio":"Co-founder & Senior Backend developer","name":"Daniel Makurat","web":null}},{"frontmatter":{"author_id":"eliasz","avatar":"/images/members/eliasz.png","bio":"Software Engineer @ Bright Inventions","name":"Eliasz Sawicki","web":"http://eluss.github.io/"}},{"frontmatter":{"author_id":"fjablonski","avatar":"/images/members/filip_jablonski.jpg","bio":"Senior iOS developer","name":"Filip Jabłoński","web":null}},{"frontmatter":{"author_id":"grzesiek","avatar":"/images/members/grzegorz_ciesla.jpg","bio":"Software Developer","name":"Grzegorz Cieśla","web":null}},{"frontmatter":{"author_id":"ivan","avatar":"/images/members/ivan.jpg","bio":"Fullstack developer","name":"Ivan Menshykov","web":null}},{"frontmatter":{"author_id":"janek","avatar":"/images/members/janhanc.jpg","bio":"Frontend developer","name":"Jan Hanc","web":null}},{"frontmatter":{"author_id":"kwysocki","avatar":"/images/members/kamil.png","bio":"Software Engineer @ Bright Inventions","name":"Kamil Wysocki","web":"https://wysockikamil.com"}},{"frontmatter":{"author_id":"karoln","avatar":"/images/members/karol_nadratowski.jpg","bio":null,"name":"Karol Nadratowski","web":null}},{"frontmatter":{"author_id":"karol r","avatar":"/images/members/karol_rinc.jpg","bio":"Backend developer","name":"Karol Rinc","web":null}},{"frontmatter":{"author_id":"kasia","avatar":"/images/members/kasia_lukasiewicz.jpg","bio":"Senior Project Manager","name":"Kasia Łukasiewicz","web":null}},{"frontmatter":{"author_id":"kasia g","avatar":"/images/members/katarzyna_galka.jpg","bio":"Project manager","name":"Katarzyna Gałka","web":null}},{"frontmatter":{"author_id":"krzysiek h","avatar":"/images/members/krzysztof_hinc.jpg","bio":"Web developer","name":"Krzysiek Hinc","web":null}},{"frontmatter":{"author_id":"krzysiek","avatar":"/images/members/krzysztof_kaczmarek.jpg","bio":"Senior iOS Developer","name":"Krzysztof Kaczmarek","web":null}},{"frontmatter":{"author_id":"maciej","avatar":"/images/members/maciej_seleman.jpg","bio":"QA Specialist","name":"Maciej Seleman","web":null}},{"frontmatter":{"author_id":"magda","avatar":"/images/members/magda_sadowska.jpg","bio":"Office & HR Assistant","name":"Magda Sadowska","web":null}},{"frontmatter":{"author_id":"maja","avatar":"/images/members/maja_puta.jpg","bio":"Junior QA Specialist","name":"Maja Puta","web":null}},{"frontmatter":{"author_id":"marcink","avatar":"/images/members/marcin_kwiatkowski.jpg","bio":null,"name":"Marcin Kwiatkowski","web":null}},{"frontmatter":{"author_id":"mateusz","avatar":"/images/members/mateusz_klimczak.jpg","bio":"Technical leader & Project manager","name":"Mateusz Klimczak","web":null}},{"frontmatter":{"author_id":"mateuszklimek","avatar":"/images/members/mateuszklimek.png","bio":"Software Engineer @ Bright Inventions","name":"Mateusz Klimek","web":null}},{"frontmatter":{"author_id":"michal k","avatar":"/images/members/michal_koszalka.jpg","bio":"Senior Backend developer","name":"Michał Koszałka","web":null}},{"frontmatter":{"author_id":"michał","avatar":"/images/members/michal_wrobel.jpg","bio":"Senior Backend Developer at Bright Inventions","name":"Michał Wróbel","web":null}},{"frontmatter":{"author_id":"michal","avatar":"/images/members/michał_łukasiewicz.jpg","bio":"Co-founder & Senior iOS developer","name":"Michał Łukasiewicz","web":null}},{"frontmatter":{"author_id":"monika","avatar":"/images/members/monika.jpg","bio":"Software Developer @ Bright Inventions","name":"Monika Niegrzybowska","web":null}},{"frontmatter":{"author_id":"nikodem","avatar":"/images/members/nikodem_kalinowski.jpg","bio":"Web developer","name":"Nikodem Kalinowski","web":null}},{"frontmatter":{"author_id":"patryk","avatar":"/images/members/patryk_huzarski.jpg","bio":"Software Developer @ Bright Inventions","name":"Patryk Huzarski","web":null}},{"frontmatter":{"author_id":"patryk sz","avatar":"/images/members/patryk_szlagowski.jpg","bio":"Senior Backend developer","name":"Patryk Szlagowski","web":null}},{"frontmatter":{"author_id":"paweł","avatar":"/images/members/paweł_gutkowski.jpg","bio":"Fullstack Developer at Bright Inventions ","name":"Paweł Gutkowski","web":null}},{"frontmatter":{"author_id":"pawel","avatar":"/images/members/paweł_papkiewicz.jpg","bio":"Fullstack developer","name":"Paweł Papkiewicz","web":null}},{"frontmatter":{"author_id":"piotr","avatar":"/images/members/piotr_mionskowski.jpg","bio":"TDD fan eager to learn new things","name":"Piotr Mionskowski","web":"https://miensol.pl"}},{"frontmatter":{"author_id":"piotr_l","avatar":"/images/members/piotrl.png","bio":"Android Developer @ Bright Inventions","name":"Piotr Łupiński","web":"http://exp.flamaster2.com"}},{"frontmatter":{"author_id":"radek","avatar":"/images/members/radek_pieczątkiewicz.jpg","bio":"Android developer","name":"Radek Pieczątkiewicz","web":null}},{"frontmatter":{"author_id":"radeks","avatar":"/images/members/radoslaw.jpg","bio":"Software Engineer @ Bright Inventions","name":"Radosław Słowiński","web":null}},{"frontmatter":{"author_id":"rafal h","avatar":"/images/members/rafal_hoffman.jpg","bio":"Fullstack developer","name":"Rafał Hofman","web":null}},{"frontmatter":{"author_id":"sebastian","avatar":"/images/members/sebastian_sobczak.jpg","bio":"Junior Account Manager at Bright Inventions ","name":"Sebastian Sobczak","web":null}},{"frontmatter":{"author_id":"szymek","avatar":"/images/members/szymon_miloch.jpg","bio":"Android & Web developer","name":"Szymon Miloch","web":null}},{"frontmatter":{"author_id":"tomek","avatar":"/images/members/tomek.jpeg","bio":null,"name":"Tomasz Gęsior","web":null}},{"frontmatter":{"author_id":"ula","avatar":"/images/members/ula_stankiewicz.jpg","bio":"HR & Marketing Manager","name":"Ula Stankiewicz","web":null}},{"frontmatter":{"author_id":"wojciech","avatar":"/images/members/wojciech_baczyński.jpg","bio":"Fullstack developer","name":"Wojciech Baczyński","web":null}},{"frontmatter":{"author_id":"lukasz","avatar":"/images/members/lukasz_reszetow.jpg","bio":"Android developer","name":"Łukasz Reszetow","web":null}}]},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-03-02-dont-fool-yourself-with-lateinit-modifier.md"}}}